<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐厅检查评分测算系统 - 深色数据看板</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- jsPDF - 用于生成PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3498db',
                        secondary: '#6366f1',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: {
                            100: '#1e293b',
                            200: '#172033',
                            300: '#0f172a',
                            400: '#0c1220',
                            500: '#060a14'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3)'
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-all {
                transition-property: all;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
            .card {
                @apply bg-dark-100 border border-dark-300 rounded-none shadow-card p-6 transition-all hover:shadow-card-hover;
            }
            .btn {
                @apply px-4 py-2 rounded-none font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-dark-300;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-dark-300 text-gray-300 hover:bg-dark-200 focus:ring-dark-100/50;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success/50;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-warning/90 focus:ring-warning/50;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
            }
            .input-field {
                @apply w-full px-3 py-2 bg-dark-200 border border-dark-300 rounded-none text-gray-300 shadow-sm focus:outline-none focus:ring-primary/50 focus:border-primary;
            }
            .label {
                @apply block text-sm font-medium text-gray-400 mb-1;
            }
            .badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-none text-xs font-medium;
            }
            .badge-danger {
                @apply bg-danger/10 text-danger;
            }
            .badge-warning {
                @apply bg-warning/10 text-warning;
            }
            .badge-success {
                @apply bg-success/10 text-success;
            }
            .table-header {
                @apply px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider;
            }
            .table-cell {
                @apply px-6 py-4 whitespace-nowrap text-sm text-gray-300;
            }
            .progress-bar {
                @apply h-2 rounded-none bg-dark-300 overflow-hidden;
            }
            .progress-value {
                @apply h-full rounded-none transition-all duration-300 ease-in-out;
            }
            .gradient-text {
                @apply bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary;
            }
            .card-border-left {
                @apply border-l-4 border-primary;
            }
            .card-border-top {
                @apply border-t-4 border-primary;
            }
            .card-border-right {
                @apply border-r-4 border-primary;
            }
            .card-border-bottom {
                @apply border-b-4 border-primary;
            }
        }
    </style>
</head>
<body class="bg-dark-400 min-h-screen text-gray-300 relative overflow-x-hidden">
    <!-- 背景网格 -->
    <div class="fixed inset-0 z-0 opacity-10">
        <div class="h-full w-full bg-[linear-gradient(to_right,#1e293b_1px,transparent_1px),linear-gradient(to_bottom,#1e293b_1px,transparent_1px)] bg-[size:24px_24px]"></div>
    </div>
    
    <!-- 粒子背景 -->
    <div id="particles-bg" class="fixed inset-0 z-0 opacity-20"></div>

    <!-- 顶部导航栏 -->
    <header class="bg-dark-300 border-b border-dark-100 relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fa fa-cutlery text-primary text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-white">餐厅检查评分测算系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="resetAllBtn" class="btn btn-secondary">
                        <i class="fa fa-refresh mr-1"></i> 重置所有
                    </button>
                    <button id="pdfUploadBtn" class="btn btn-secondary mr-2">
                        <i class="fa fa-file-pdf-o text-blue-400 mr-1"></i> PDF上传分析
                    </button>
                    <button id="aiAnalysisBtn" class="btn btn-secondary mr-2">
                        <i class="fa fa-brain text-purple-400 mr-1"></i> AI分析
                    </button>
                    <button id="exportBtn" class="btn btn-primary">
                        <i class="fa fa-download mr-1"></i> 导出数据
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">
        <!-- 系统概览 -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card card-border-left">
                <h3 class="text-gray-400 text-sm">已添加餐厅</h3>
                <p id="totalRestaurants" class="text-3xl font-bold text-white mt-1">0</p>
                <div class="mt-2 flex items-center text-xs">
                    <span class="text-gray-500">较上次</span>
                    <span id="restaurantChange" class="ml-2 text-green-400">+0</span>
                </div>
            </div>
            <div class="card card-border-left">
                <h3 class="text-gray-400 text-sm">平均综合评分</h3>
                <p id="avgScore" class="text-3xl font-bold text-white mt-1">0.00</p>
                <div class="mt-2 flex items-center text-xs">
                    <span class="text-gray-500">较上次</span>
                    <span id="scoreChange" class="ml-2 text-green-400">+0.00</span>
                </div>
            </div>
            <div class="card card-border-left">
                <h3 class="text-gray-400 text-sm">平均覆盖充分度</h3>
                <p id="avgCoverage" class="text-3xl font-bold text-white mt-1">0.00</p>
                <div class="mt-2 flex items-center text-xs">
                    <span class="text-gray-500">较上次</span>
                    <span id="coverageChange" class="ml-2 text-green-400">+0.00</span>
                </div>
            </div>
            <div class="card card-border-left">
                <h3 class="text-gray-400 text-sm">平均问题严重度</h3>
                <p id="avgSeverity" class="text-3xl font-bold text-white mt-1">0.00</p>
                <div class="mt-2 flex items-center text-xs">
                    <span class="text-gray-500">较上次</span>
                    <span id="severityChange" class="ml-2 text-red-400">+0.00</span>
                </div>
            </div>
        </section>

        <!-- 日期设置区 -->
        <section class="card mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-white flex items-center">
                    <i class="fa fa-calendar text-green-400 mr-2"></i> 日期设置
                </h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="checkDate" class="label">检查日期</label>
                    <input type="date" id="checkDate" class="input-field" value="">
                </div>
                <div>
                    <label for="dateRangeStart" class="label">开始日期</label>
                    <input type="date" id="dateRangeStart" class="input-field" value="">
                </div>
                <div>
                    <label for="dateRangeEnd" class="label">结束日期</label>
                    <input type="date" id="dateRangeEnd" class="input-field" value="">
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="applyDateFilterBtn" class="btn btn-primary">
                    <i class="fa fa-filter mr-1"></i> 应用日期筛选
                </button>
            </div>
        </section>
        
        <!-- 评分设置区 -->
        <section class="card mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-white flex items-center">
                    <i class="fa fa-cog text-primary mr-2"></i> 基础设置
                </h2>
                <div class="flex items-center">
                    <span class="text-xs text-gray-500">最后更新: <span id="lastUpdated">2025-07-21 15:30</span></span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="targetCoverage" class="label">检查覆盖目标值</label>
                    <div class="flex items-center">
                        <input type="number" id="targetCoverage" value="1" min="0.1" step="0.1" class="input-field">
                        <span class="ml-2 text-gray-400">次/档口</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">默认值为1次/档口，可根据实际情况调整</p>
                </div>
                <div>
                    <label class="label">问题权重设置</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-xs text-gray-500">一般问题</label>
                            <div class="flex items-center">
                                <input type="number" id="weightGeneral" value="1" min="1" max="10" class="input-field">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">较重问题</label>
                            <div class="flex items-center">
                                <input type="number" id="weightSerious" value="3" min="1" max="10" class="input-field">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">严重问题</label>
                            <div class="flex items-center">
                                <input type="number" id="weightCritical" value="5" min="1" max="10" class="input-field">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 数据输入区 -->
        <section class="card mb-8">
            <h2 class="text-lg font-semibold text-white mb-6 flex items-center">
                <i class="fa fa-pencil-square-o text-primary mr-2"></i> 数据输入
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label for="restaurantName" class="label">餐厅名称</label>
                    <input type="text" id="restaurantName" placeholder="请输入餐厅名称" class="input-field">
                </div>
                <div>
                    <label for="stallCount" class="label">档口数</label>
                    <input type="number" id="stallCount" min="1" placeholder="请输入档口数量" class="input-field">
                </div>
                <div>
                    <label for="inspectionCount" class="label">检查次数</label>
                    <input type="number" id="inspectionCount" min="0" placeholder="请输入检查次数" class="input-field">
                </div>
                <div>
                    <label for="generalIssues" class="label">一般问题数</label>
                    <input type="number" id="generalIssues" min="0" placeholder="请输入一般问题数量" class="input-field">
                </div>
                <div>
                    <label for="seriousIssues" class="label">较重问题数</label>
                    <input type="number" id="seriousIssues" min="0" placeholder="请输入较重问题数量" class="input-field">
                </div>
                <div>
                    <label for="criticalIssues" class="label">严重问题数</label>
                    <input type="number" id="criticalIssues" min="0" placeholder="请输入严重问题数量" class="input-field">
                </div>
                <div>
                    <label for="restaurantDate" class="label">检查日期</label>
                    <input type="date" id="restaurantDate" class="input-field" value="">
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="calculateBtn" class="btn btn-primary">
                    <i class="fa fa-calculator mr-1"></i> 计算评分
                </button>
                <button id="addRestaurantBtn" class="btn btn-success ml-3">
                    <i class="fa fa-plus mr-1"></i> 添加到列表
                </button>
            </div>
        </section>

        <!-- 自动计算区 -->
        <section class="card mb-8">
            <h2 class="text-lg font-semibold text-white mb-6 flex items-center">
                <i class="fa fa-cogs text-primary mr-2"></i> 自动计算结果
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-dark-200 p-4 border-l-2 border-primary">
                    <h3 class="text-sm font-medium text-gray-400">餐厅检查覆盖充分度</h3>
                    <div class="mt-2 flex items-end">
                        <span id="coverageRate" class="text-3xl font-bold text-white">0.00</span>
                        <span class="ml-1 text-gray-400">次/档口</span>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>0</span>
                            <span>目标: <span id="coverageTargetDisplay">1.0</span></span>
                        </div>
                        <div class="progress-bar">
                            <div id="coverageProgress" class="progress-value bg-primary" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-dark-200 p-4 border-l-2 border-warning">
                    <h3 class="text-sm font-medium text-gray-400">餐厅问题严重度</h3>
                    <div class="mt-2 flex items-end">
                        <span id="issueSeverity" class="text-3xl font-bold text-white">0.00</span>
                        <span class="ml-1 text-gray-400">分/档口</span>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>0</span>
                            <span>5</span>
                        </div>
                        <div class="progress-bar">
                            <div id="severityProgress" class="progress-value bg-warning" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-dark-200 p-4 border-l-2 border-success">
                    <h3 class="text-sm font-medium text-gray-400">综合评分</h3>
                    <div class="mt-2 flex items-end">
                        <span id="compositeScore" class="text-3xl font-bold text-white">0.00</span>
                        <span class="ml-1 text-gray-400">分</span>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>0 (优)</span>
                            <span>5 (差)</span>
                        </div>
                        <div class="progress-bar">
                            <div id="scoreProgress" class="progress-value bg-success" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-xs text-gray-500 bg-dark-200 p-3 border-l-2 border-dark-300">
                <p class="text-gray-400 mb-2">计算公式说明：</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>餐厅检查覆盖充分度 = 检查次数 ÷ 档口数</li>
                    <li>餐厅问题严重度 = (一般问题×<span id="weightGeneralDisplay" class="text-primary">1</span> + 较重问题×<span id="weightSeriousDisplay" class="text-primary">3</span> + 严重问题×<span id="weightCriticalDisplay" class="text-primary">5</span>) ÷ 档口数</li>
                    <li>综合评分 = (问题严重度 × 0.7) + (1 - 覆盖充分度 ÷ 目标值) × 0.3</li>
                </ul>
            </div>
        </section>

        <!-- 结果输出区 -->
        <section class="card mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-white flex items-center">
                    <i class="fa fa-trophy text-primary mr-2"></i> 餐厅排名与优先级
                </h2>
                <button id="generatePdfReportBtn" class="btn btn-secondary flex items-center">
                    <i class="fa fa-file-pdf-o text-red-400 mr-1"></i> 导出PDF报告
                </button>
                <div class="flex items-center">
                    <span class="text-xs text-gray-500 mr-2">排序方式:</span>
                    <select id="sortBy" class="text-xs bg-dark-200 border border-dark-300 rounded-none text-gray-300 focus:outline-none focus:ring-primary/50 focus:border-primary">
                        <option value="scoreAsc">综合评分 (低→高)</option>
                        <option value="scoreDesc">综合评分 (高→低)</option>
                        <option value="severityAsc">问题严重度 (低→高)</option>
                        <option value="severityDesc">问题严重度 (高→低)</option>
                        <option value="coverageAsc">覆盖充分度 (低→高)</option>
                        <option value="coverageDesc">覆盖充分度 (高→低)</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto bg-dark-200">
                <table class="min-w-full divide-y divide-dark-300">
                    <thead class="bg-dark-300">
                        <tr>
                            <th scope="col" class="table-header">排名</th>
                            <th scope="col" class="table-header">餐厅名称</th>
                            <th scope="col" class="table-header">档口数</th>
                            <th scope="col" class="table-header">检查次数</th>
                            <th scope="col" class="table-header">问题总数</th>
                            <th scope="col" class="table-header">覆盖充分度</th>
                            <th scope="col" class="table-header">问题严重度</th>
                            <th scope="col" class="table-header">综合评分</th>
                            <th scope="col" class="table-header">整改优先级</th>
                            <th scope="col" class="table-header">操作</th>
                        </tr>
                    </thead>
                    <tbody id="restaurantTableBody" class="bg-dark-200 divide-y divide-dark-300">
                        <!-- 餐厅数据将通过JavaScript动态添加 -->
                        <tr>
                            <td colspan="10" class="table-cell text-center text-gray-500">暂无数据，请添加餐厅</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- 数据操作工具栏 -->
        <section id="dataOperationsSection" class="mb-8">
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fa fa-database text-green-400 mr-2"></i> 数据管理
                    </h2>
                    <div class="flex space-x-2">
                        <button id="saveDataBtn" class="text-xs bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            保存数据
                        </button>
                        <button id="loadDataBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            加载数据
                        </button>
                        <button id="exportDataBtn" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            导出数据
                        </button>
                        <label for="importDataInput" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-none transition-colors duration-150 cursor-pointer">
                            导入数据
                            <input id="importDataInput" type="file" accept=".json" class="hidden">
                        </label>
                        <button id="clearDataBtn" class="text-xs bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            清除数据
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 餐厅对比功能区域 -->
        <section id="comparisonSection" class="mb-8">
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fa fa-bar-chart text-blue-400 mr-2"></i> 餐厅对比分析
                    </h2>
                    <div class="flex space-x-2">
                        <button id="addComparisonBtn" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            添加对比餐厅
                        </button>
                        <button id="clearComparisonBtn" class="text-xs bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-none transition-colors duration-150">
                            清除对比
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 餐厅对比选择区 -->
                    <div id="comparisonSelection" class="bg-dark-200 p-4 min-h-[120px]">
                        <div class="text-sm text-gray-400 mb-2">已选择餐厅：</div>
                        <div id="selectedRestaurants" class="flex flex-wrap gap-2">
                            <!-- 选择的餐厅标签将通过JavaScript动态添加 -->
                            <div class="text-gray-500 text-sm">未选择餐厅</div>
                        </div>
                    </div>
                    
                    <!-- 对比方式选择 -->
                    <div class="bg-dark-200 p-4">
                        <div class="text-sm text-gray-400 mb-2">对比方式：</div>
                        <div class="flex gap-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="comparisonType" value="vertical" checked class="form-radio text-blue-500 bg-dark-300 border-gray-600">
                                <span class="ml-2 text-sm text-gray-300">餐厅间对比（横向）</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="comparisonType" value="horizontal" class="form-radio text-blue-500 bg-dark-300 border-gray-600">
                                <span class="ml-2 text-sm text-gray-300">历史对比（纵向）</span>
                            </label>
                        </div>
                        <div class="mt-4">
                            <button id="compareBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-none transition-colors duration-150 disabled:opacity-50 disabled:hover:bg-blue-600" disabled>
                                开始对比
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 对比结果展示区 -->
                <div id="comparisonResult" class="mt-6 hidden">
                    <h3 class="text-md font-semibold text-gray-300 mb-4">对比结果</h3>
                    <div class="bg-dark-200 p-4">
                        <canvas id="comparisonChart" height="300"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-dark-200 p-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">关键指标对比</h4>
                            <div id="comparisonMetrics" class="space-y-2">
                                <!-- 关键指标对比将通过JavaScript动态添加 -->
                            </div>
                        </div>
                        <div class="bg-dark-200 p-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">对比分析</h4>
                            <div id="comparisonAnalysis" class="text-sm text-gray-400">
                                <!-- 对比分析结果将通过JavaScript动态添加 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

            <!-- AI分析结果区域 -->
        <section id="aiAnalysisSection" class="mb-8 hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fa fa-microchip text-purple-400 mr-2"></i> AI深度分析结果
                    </h2>
                    <span class="text-xs text-gray-500" id="analysisTime">分析时间: 未分析</span>
                </div>
                <div class="bg-dark-300 p-6 rounded border border-dark-500 max-h-96 overflow-y-auto" id="aiAnalysisResult">
                    <div class="text-center text-gray-400 py-10">
                        <i class="fa fa-robot text-4xl mb-3 text-purple-400"></i>
                        <p>暂无AI分析结果</p>
                        <p class="text-sm mt-2">请点击顶部的"AI分析"按钮进行深度分析</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="generatePdfBtn" class="btn btn-secondary mr-2 hidden">
                        <i class="fa fa-file-pdf-o mr-1"></i> 生成PDF报告
                    </button>
                    <button id="regenerateAnalysisBtn" class="btn btn-secondary hidden">
                        <i class="fa fa-refresh mr-1"></i> 重新分析
                    </button>
                </div>
            </div>
        </section>

        <!-- 可视化区 -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 综合评分柱状图 -->
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fa fa-bar-chart text-primary mr-2"></i> 餐厅综合评分柱状图
                    </h2>
                    <div class="flex space-x-2">
                        <button class="px-2 py-1 text-xs bg-dark-300 hover:bg-dark-200 text-gray-300">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="h-80">
                    <canvas id="scoreBarChart"></canvas>
                </div>
            </div>
            
            <!-- 餐厅多维度指标雷达图 -->
            <div class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fa fa-pie-chart text-primary mr-2"></i> 餐厅多维度指标分析
                    </h2>
                    <div class="flex space-x-2">
                        <button class="px-2 py-1 text-xs bg-dark-300 hover:bg-dark-200 text-gray-300">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="h-80">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部信息 -->
    <footer class="bg-dark-300 border-t border-dark-100 relative z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <p class="text-xs text-gray-500">© 2025 餐厅检查评分测算系统 - 深色数据看板</p>
                <div class="flex items-center space-x-4">
                    <button id="helpBtn" class="text-xs text-gray-500 hover:text-primary">
                        <i class="fa fa-question-circle mr-1"></i> 帮助
                    </button>
                    <button id="aboutBtn" class="text-xs text-gray-500 hover:text-primary">
                        <i class="fa fa-info-circle mr-1"></i> 关于
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- DeepSeek API 设置模态框 -->
    <div id="deepseekSettingsModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-200 border border-dark-100 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">DeepSeek API 设置</h3>
                    <button id="closeDeepseekSettingsBtn" class="text-gray-400 hover:text-gray-300">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label for="deepseekApiKey" class="block text-sm font-medium text-gray-300 mb-2">API Key</label>
                        <input type="password" id="deepseekApiKey" class="w-full bg-dark-300 border border-dark-400 rounded px-3 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入DeepSeek API Key">
                        <p class="mt-1 text-xs text-gray-500">获取API Key请访问DeepSeek官网</p>
                    </div>
                    
                    <div>
                        <label for="analysisMode" class="block text-sm font-medium text-gray-300 mb-2">分析模式</label>
                        <select id="analysisMode" class="w-full bg-dark-300 border border-dark-400 rounded px-3 py-2 text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="standard">标准分析</option>
                            <option value="detailed">详细分析</option>
                            <option value="comprehensive">全面分析（包含法规依据）</option>
                        </select>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-300 mb-3">分析标准（可多选）</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="standardFoodSafety" class="w-4 h-4 bg-dark-300 border-dark-400 text-primary rounded focus:ring-primary" checked>
                                <label for="standardFoodSafety" class="ml-2 text-sm text-gray-300">中华人民共和国食品安全法</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="standardOperation" class="w-4 h-4 bg-dark-300 border-dark-400 text-primary rounded focus:ring-primary" checked>
                                <label for="standardOperation" class="ml-2 text-sm text-gray-300">餐饮服务食品安全操作规范</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="standardIso9001" class="w-4 h-4 bg-dark-300 border-dark-400 text-primary rounded focus:ring-primary" checked>
                                <label for="standardIso9001" class="ml-2 text-sm text-gray-300">ISO 9001质量管理体系</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="standardHaccp" class="w-4 h-4 bg-dark-300 border-dark-400 text-primary rounded focus:ring-primary" checked>
                                <label for="standardHaccp" class="ml-2 text-sm text-gray-300">HACCP食品风险控制点体系</label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="temperature" class="block text-sm font-medium text-gray-300 mb-2">分析温度（0-1之间，越高结果越多样化）</label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="w-full h-2 bg-dark-400 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0.0</span>
                            <span id="temperatureValue">0.7</span>
                            <span>1.0</span>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex justify-end space-x-4">
                        <button id="saveDeepseekSettingsBtn" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded">保存设置</button>
                        <button id="runAnalysisNowBtn" class="px-4 py-2 bg-success hover:bg-success/90 text-white rounded">立即分析</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- PDF上传模态框 -->
        <div id="pdfUploadModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-dark-300 rounded-lg shadow-xl w-full max-w-2xl p-6 border border-dark-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">PDF上传与分析</h3>
                    <button id="closePdfUploadModal" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">选择PDF文件</label>
                    <div class="border-2 border-dashed border-dark-100 rounded-lg p-8 text-center hover:border-primary/50 transition-all cursor-pointer" id="pdfDropZone">
                        <i class="fa fa-file-pdf-o text-5xl mb-3 text-blue-400"></i>
                        <p class="text-gray-300 mb-2">点击或拖放PDF文件到此处</p>
                        <p class="text-sm text-gray-500">支持的格式: PDF (最大 10MB)</p>
                        <input type="file" id="pdfFileInput" class="hidden" accept=".pdf">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 mb-2">选择分析标准</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="standardFoodSafety" class="form-checkbox text-primary bg-dark-200 border-dark-100 rounded" checked>
                            <span class="ml-2 text-gray-300">中华人民共和国食品安全法</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="standardOperation" class="form-checkbox text-primary bg-dark-200 border-dark-100 rounded" checked>
                            <span class="ml-2 text-gray-300">餐饮服务食品安全操作规范</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="standardIso9001" class="form-checkbox text-primary bg-dark-200 border-dark-100 rounded" checked>
                            <span class="ml-2 text-gray-300">ISO 9001质量管理体系</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="standardHaccp" class="form-checkbox text-primary bg-dark-200 border-dark-100 rounded" checked>
                            <span class="ml-2 text-gray-300">HACCP食品风险控制点体系</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancelPdfUploadBtn" class="btn btn-secondary">取消</button>
                    <button id="startAnalysisBtn" class="btn btn-primary" disabled>开始分析</button>
                </div>
            </div>
        </div>

        <!-- PDF分析结果模态框 -->
        <div id="pdfAnalysisResultModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="bg-dark-300 rounded-lg shadow-xl w-full max-w-4xl p-6 border border-dark-100 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">PDF分析结果</h3>
                    <button id="closePdfResultModal" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="pdfAnalysisLoading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
                    <p class="text-gray-300">正在分析PDF文件，请稍候...</p>
                </div>
                
                <div id="pdfAnalysisContent" class="hidden">
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-white mb-3">文件信息</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-dark-400 p-3 rounded">
                                <p class="text-sm text-gray-400">文件名</p>
                                <p id="pdfFileName" class="text-white">-</p>
                            </div>
                            <div class="bg-dark-400 p-3 rounded">
                                <p class="text-sm text-gray-400">分析时间</p>
                                <p id="pdfAnalysisTime" class="text-white">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-white mb-3">合规性分析</h4>
                        <div id="complianceResult" class="space-y-4">
                            <!-- 分析结果将在此显示 -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-white mb-3">发现的问题</h4>
                        <div id="issuesList" class="space-y-3">
                            <!-- 问题列表将在此显示 -->
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-white mb-3">整改建议</h4>
                        <div id="suggestionsList" class="bg-dark-400 p-4 rounded">
                            <p id="pdfSuggestions" class="text-gray-300">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="downloadPdfReportBtn" class="btn btn-secondary">
                        <i class="fa fa-download mr-1"></i> 下载报告
                    </button>
                    <button id="addDataBtn" class="btn btn-primary">
                        <i class="fa fa-plus-circle mr-1"></i> 添加到系统
                    </button>
                </div>
            </div>
        </div>

        <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-200 border border-dark-100 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">使用帮助</h3>
                    <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-300">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="prose prose-invert max-w-none">
                    <h4 class="text-lg font-medium text-white">1. 基础设置</h4>
                    <p class="text-gray-300">设置检查覆盖目标值（默认1次/档口）和问题权重（一般、较重、严重问题的权重值）。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">2. 数据输入</h4>
                    <p class="text-gray-300">输入餐厅名称、档口数、检查次数以及各类问题数量（一般、较重、严重）。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">3. 计算评分</h4>
                    <p class="text-gray-300">点击"计算评分"按钮，系统将自动计算餐厅检查覆盖充分度、问题严重度和综合评分。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">4. 添加到列表</h4>
                    <p class="text-gray-300">计算完成后，点击"添加到列表"按钮将当前餐厅数据添加到排名列表中。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">5. 查看结果</h4>
                    <p class="text-gray-300">在结果输出区查看餐厅排名和整改优先级，在可视化区查看评分柱状图和散点图。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">6. 导出数据</h4>
                    <p class="text-gray-300">点击顶部的"导出数据"按钮，可将所有餐厅数据导出为CSV格式。</p>
                    
                    <h4 class="text-lg font-medium text-white mt-4">计算公式说明</h4>
                    <ul class="list-disc pl-5 text-gray-300">
                        <li>餐厅检查覆盖充分度 = 检查次数 ÷ 档口数</li>
                        <li>餐厅问题严重度 = (一般问题×权重1 + 较重问题×权重2 + 严重问题×权重3) ÷ 档口数</li>
                        <li>综合评分 = (问题严重度 × 0.7) + (1 - 覆盖充分度 ÷ 目标值) × 0.3</li>
                    </ul>
                    
                    <h4 class="text-lg font-medium text-white mt-4">整改优先级说明</h4>
                    <ul class="list-disc pl-5 text-gray-300">
                        <li>红色（高优先级）：综合评分 ≥ 2分</li>
                        <li>黄色（中优先级）：综合评分 1-2分</li>
                        <li>绿色（低优先级）：综合评分 &lt; 1分</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 关于模态框 -->
    <div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-dark-200 border border-dark-100 max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">关于系统</h3>
                    <button id="closeAboutBtn" class="text-gray-400 hover:text-gray-300">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="text-center">
                    <i class="fa fa-cutlery text-primary text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-white">餐厅检查评分测算系统</h4>
                    <p class="text-gray-500 mt-2">版本 1.0.0</p>
                    <div class="mt-4 text-xs text-gray-400">
                        <p>本系统旨在帮助餐饮行业管理者和食品安全检查员快速评估餐厅的检查表现，通过标准化的数据输入和精准的计算公式，自动生成餐厅的综合评分、排名和整改优先级，从而提高管理效率和决策质量。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 全局变量
        let restaurants = [];
        let scoreBarChart = null;
        let scatterChart = null;
        let previousStats = {
            totalRestaurants: 0,
            avgScore: 0,
            avgCoverage: 0,
            avgSeverity: 0
        };
        
        // DOM 元素
        const targetCoverageInput = document.getElementById('targetCoverage');
        const weightGeneralInput = document.getElementById('weightGeneral');
        const weightSeriousInput = document.getElementById('weightSerious');
        const weightCriticalInput = document.getElementById('weightCritical');
        
        const restaurantNameInput = document.getElementById('restaurantName');
        const stallCountInput = document.getElementById('stallCount');
        const inspectionCountInput = document.getElementById('inspectionCount');
        const generalIssuesInput = document.getElementById('generalIssues');
        const seriousIssuesInput = document.getElementById('seriousIssues');
        const criticalIssuesInput = document.getElementById('criticalIssues');
        
        const calculateBtn = document.getElementById('calculateBtn');
        const addRestaurantBtn = document.getElementById('addRestaurantBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const exportBtn = document.getElementById('exportBtn');
        
        const coverageRateSpan = document.getElementById('coverageRate');
        const issueSeveritySpan = document.getElementById('issueSeverity');
        const compositeScoreSpan = document.getElementById('compositeScore');
        
        const coverageProgressDiv = document.getElementById('coverageProgress');
        const severityProgressDiv = document.getElementById('severityProgress');
        const scoreProgressDiv = document.getElementById('scoreProgress');
        
        const coverageTargetDisplaySpan = document.getElementById('coverageTargetDisplay');
        const weightGeneralDisplaySpan = document.getElementById('weightGeneralDisplay');
        const weightSeriousDisplaySpan = document.getElementById('weightSeriousDisplay');
        const weightCriticalDisplaySpan = document.getElementById('weightCriticalDisplay');
        
        const restaurantTableBody = document.getElementById('restaurantTableBody');
        const sortBySelect = document.getElementById('sortBy');
        
        const helpBtn = document.getElementById('helpBtn');
        const aboutBtn = document.getElementById('aboutBtn');
        const helpModal = document.getElementById('helpModal');
        const aboutModal = document.getElementById('aboutModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const closeAboutBtn = document.getElementById('closeAboutBtn');
        
        // DeepSeek API 相关元素
        const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
        const deepseekSettingsModal = document.getElementById('deepseekSettingsModal');
        const closeDeepseekSettingsBtn = document.getElementById('closeDeepseekSettingsBtn');
        const deepseekApiKeyInput = document.getElementById('deepseekApiKey');
        const analysisModeSelect = document.getElementById('analysisMode');
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValueSpan = document.getElementById('temperatureValue');
        const saveDeepseekSettingsBtn = document.getElementById('saveDeepseekSettingsBtn');
        const runAnalysisNowBtn = document.getElementById('runAnalysisNowBtn');
        const aiAnalysisSection = document.getElementById('aiAnalysisSection');
        const aiAnalysisResultDiv = document.getElementById('aiAnalysisResult');
        const analysisTimeSpan = document.getElementById('analysisTime');
        const generatePdfBtn = document.getElementById('generatePdfBtn');
        const regenerateAnalysisBtn = document.getElementById('regenerateAnalysisBtn');
        
        // 统计数据元素
        const totalRestaurantsSpan = document.getElementById('totalRestaurants');
        const avgScoreSpan = document.getElementById('avgScore');
        const avgCoverageSpan = document.getElementById('avgCoverage');
        const avgSeveritySpan = document.getElementById('avgSeverity');
        
        const restaurantChangeSpan = document.getElementById('restaurantChange');
        const scoreChangeSpan = document.getElementById('scoreChange');
        const coverageChangeSpan = document.getElementById('coverageChange');
        const severityChangeSpan = document.getElementById('severityChange');
        
        const lastUpdatedSpan = document.getElementById('lastUpdated');
        
        // 初始化
        function init() {
            // 更新权重显示
            updateWeightDisplays();
            
            // 更新最后更新时间
            updateLastUpdated();
            
            // 绑定事件
            targetCoverageInput.addEventListener('input', updateCoverageTargetDisplay);
            weightGeneralInput.addEventListener('input', updateWeightDisplays);
            weightSeriousInput.addEventListener('input', updateWeightDisplays);
            weightCriticalInput.addEventListener('input', updateWeightDisplays);
            
            calculateBtn.addEventListener('click', calculateScores);
            addRestaurantBtn.addEventListener('click', addRestaurant);
            resetAllBtn.addEventListener('click', resetAll);
            exportBtn.addEventListener('click', exportData);
            
            sortBySelect.addEventListener('change', sortRestaurants);
            
            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            aboutBtn.addEventListener('click', () => aboutModal.classList.remove('hidden'));
            closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            closeAboutBtn.addEventListener('click', () => aboutModal.classList.add('hidden'));
            
            // DeepSeek API 相关事件监听
            aiAnalysisBtn.addEventListener('click', showDeepseekSettings);
            closeDeepseekSettingsBtn.addEventListener('click', () => deepseekSettingsModal.classList.add('hidden'));
            temperatureSlider.addEventListener('input', updateTemperatureValue);
            saveDeepseekSettingsBtn.addEventListener('click', saveDeepseekSettings);
            runAnalysisNowBtn.addEventListener('click', runDeepseekAnalysis);
            regenerateAnalysisBtn.addEventListener('click', runDeepseekAnalysis);
            generatePdfBtn.addEventListener('click', generateAnalysisPdfReport);
            
            // 初始化图表
            initCharts();
            
            // 初始化粒子背景
            initParticlesBackground();
            
            // 示例数据
            addExampleData();
        }
        
        // 更新最后更新时间
        function updateLastUpdated() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            lastUpdatedSpan.textContent = `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // 更新覆盖目标显示
        function updateCoverageTargetDisplay() {
            coverageTargetDisplaySpan.textContent = parseFloat(targetCoverageInput.value).toFixed(1);
        }
        
        // 更新权重显示
        function updateWeightDisplays() {
            weightGeneralDisplaySpan.textContent = weightGeneralInput.value;
            weightSeriousDisplaySpan.textContent = weightSeriousInput.value;
            weightCriticalDisplaySpan.textContent = weightCriticalInput.value;
        }
        
        // 计算评分
        function calculateScores() {
            // 获取输入值
            const stallCount = parseInt(stallCountInput.value) || 0;
            const inspectionCount = parseInt(inspectionCountInput.value) || 0;
            const generalIssues = parseInt(generalIssuesInput.value) || 0;
            const seriousIssues = parseInt(seriousIssuesInput.value) || 0;
            const criticalIssues = parseInt(criticalIssuesInput.value) || 0;
            
            // 获取权重
            const weightGeneral = parseInt(weightGeneralInput.value) || 1;
            const weightSerious = parseInt(weightSeriousInput.value) || 3;
            const weightCritical = parseInt(weightCriticalInput.value) || 5;
            
            // 获取目标覆盖值
            const targetCoverage = parseFloat(targetCoverageInput.value) || 1;
            
            // 验证输入
            if (stallCount <= 0) {
                alert('请输入有效的档口数');
                stallCountInput.focus();
                return;
            }
            
            // 计算覆盖充分度
            const coverageRate = inspectionCount / stallCount;
            
            // 计算问题严重度
            const totalIssueScore = (generalIssues * weightGeneral) + 
                                   (seriousIssues * weightSerious) + 
                                   (criticalIssues * weightCritical);
            const issueSeverity = totalIssueScore / stallCount;
            
            // 计算综合评分
            const coverageFactor = 1 - (coverageRate / targetCoverage);
            const compositeScore = (issueSeverity * 0.7) + (coverageFactor * 0.3);
            
            // 更新显示
            coverageRateSpan.textContent = coverageRate.toFixed(2);
            issueSeveritySpan.textContent = issueSeverity.toFixed(2);
            compositeScoreSpan.textContent = compositeScore.toFixed(2);
            
            // 更新进度条
            const coveragePercentage = Math.min(100, (coverageRate / targetCoverage) * 100);
            coverageProgressDiv.style.width = `${coveragePercentage}%`;
            
            const severityPercentage = Math.min(100, (issueSeverity / 5) * 100);
            severityProgressDiv.style.width = `${severityPercentage}%`;
            
            const scorePercentage = Math.min(100, (compositeScore / 5) * 100);
            scoreProgressDiv.style.width = `${scorePercentage}%`;
            
            // 更新进度条颜色
            updateProgressColors(compositeScore);
        }
        
        // 更新进度条颜色
        function updateProgressColors(score) {
            if (score >= 2) {
                scoreProgressDiv.className = 'progress-value bg-danger';
            } else if (score >= 1) {
                scoreProgressDiv.className = 'progress-value bg-warning';
            } else {
                scoreProgressDiv.className = 'progress-value bg-success';
            }
        }
        
        // 添加餐厅
        function addRestaurant() {
            // 获取输入值
            const name = restaurantNameInput.value.trim();
            const stallCount = parseInt(stallCountInput.value) || 0;
            const inspectionCount = parseInt(inspectionCountInput.value) || 0;
            const generalIssues = parseInt(generalIssuesInput.value) || 0;
            const seriousIssues = parseInt(seriousIssuesInput.value) || 0;
            const criticalIssues = parseInt(criticalIssuesInput.value) || 0;
            
            // 获取权重
            const weightGeneral = parseInt(weightGeneralInput.value) || 1;
            const weightSerious = parseInt(weightSeriousInput.value) || 3;
            const weightCritical = parseInt(weightCriticalInput.value) || 5;
            
            // 获取目标覆盖值
            const targetCoverage = parseFloat(targetCoverageInput.value) || 1;
            
            // 验证输入
            if (!name) {
                alert('请输入餐厅名称');
                restaurantNameInput.focus();
                return;
            }
            
            if (stallCount <= 0) {
                alert('请输入有效的档口数');
                stallCountInput.focus();
                return;
            }
            
            // 计算评分
            const coverageRate = inspectionCount / stallCount;
            const totalIssueScore = (generalIssues * weightGeneral) + 
                                   (seriousIssues * weightSerious) + 
                                   (criticalIssues * weightCritical);
            const issueSeverity = totalIssueScore / stallCount;
            const coverageFactor = 1 - (coverageRate / targetCoverage);
            const compositeScore = (issueSeverity * 0.7) + (coverageFactor * 0.3);
            
            // 创建餐厅对象
            const restaurant = {
                id: Date.now(),
                name,
                stallCount,
                inspectionCount,
                generalIssues,
                seriousIssues,
                criticalIssues,
                totalIssues: generalIssues + seriousIssues + criticalIssues,
                coverageRate,
                issueSeverity,
                compositeScore,
                priority: getPriority(compositeScore)
            };
            
            // 添加到列表
            restaurants.push(restaurant);
            
            // 更新统计数据
            updateStatistics();
            
            // 排序餐厅
            sortRestaurants();
            
            // 更新表格
            updateRestaurantTable();
            
            // 更新图表
            updateCharts();
            
            // 清空输入
            clearInputFields();
            
            // 更新最后更新时间
            updateLastUpdated();
        }
        
        // 获取优先级
        function getPriority(score) {
            if (score >= 2) {
                return { level: 'high', label: '高', color: 'danger', bgColor: 'bg-danger/10' };
            } else if (score >= 1) {
                return { level: 'medium', label: '中', color: 'warning', bgColor: 'bg-warning/10' };
            } else {
                return { level: 'low', label: '低', color: 'success', bgColor: 'bg-success/10' };
            }
        }
        
        // 排序餐厅
        function sortRestaurants() {
            const sortBy = sortBySelect.value;
            
            switch (sortBy) {
                case 'scoreAsc':
                    restaurants.sort((a, b) => a.compositeScore - b.compositeScore);
                    break;
                case 'scoreDesc':
                    restaurants.sort((a, b) => b.compositeScore - a.compositeScore);
                    break;
                case 'severityAsc':
                    restaurants.sort((a, b) => a.issueSeverity - b.issueSeverity);
                    break;
                case 'severityDesc':
                    restaurants.sort((a, b) => b.issueSeverity - a.issueSeverity);
                    break;
                case 'coverageAsc':
                    restaurants.sort((a, b) => a.coverageRate - b.coverageRate);
                    break;
                case 'coverageDesc':
                    restaurants.sort((a, b) => b.coverageRate - a.coverageRate);
                    break;
            }
            
            // 更新表格
            updateRestaurantTable();
            
            // 更新图表
            updateCharts();
        }
        
        // 更新餐厅表格
        function updateRestaurantTable() {
            // 清空表格
            restaurantTableBody.innerHTML = '';
            
            // 如果没有数据，显示提示
            if (restaurants.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="10" class="table-cell text-center text-gray-500">暂无数据，请添加餐厅</td>
                `;
                restaurantTableBody.appendChild(row);
                return;
            }
            
            // 添加餐厅数据
            restaurants.forEach((restaurant, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-dark-200' : 'bg-dark-300';
                
                row.innerHTML = `
                    <td class="table-cell">${index + 1}</td>
                    <td class="table-cell font-medium">${restaurant.name}</td>
                    <td class="table-cell">${restaurant.stallCount}</td>
                    <td class="table-cell">${restaurant.inspectionCount}</td>
                    <td class="table-cell">${restaurant.totalIssues}</td>
                    <td class="table-cell">${restaurant.coverageRate.toFixed(2)}</td>
                    <td class="table-cell">${restaurant.issueSeverity.toFixed(2)}</td>
                    <td class="table-cell font-medium">${restaurant.compositeScore.toFixed(2)}</td>
                    <td class="table-cell">
                        <span class="badge ${restaurant.priority.bgColor} text-${restaurant.priority.color}">
                            ${restaurant.priority.label}优先级
                        </span>
                    </td>
                    <td class="table-cell">
                        <button class="text-red-400 hover:text-red-300 delete-btn" data-id="${restaurant.id}">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                restaurantTableBody.appendChild(row);
            });
            
            // 绑定删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteRestaurant(id);
                });
            });
        }
        
        // 删除餐厅
        function deleteRestaurant(id) {
            if (confirm('确定要删除这家餐厅的数据吗？')) {
                // 保存当前统计数据用于计算变化
                saveCurrentStats();
                
                // 删除餐厅
                restaurants = restaurants.filter(restaurant => restaurant.id !== id);
                
                // 更新统计数据
                updateStatistics();
                
                // 更新表格
                updateRestaurantTable();
                
                // 更新图表
                updateCharts();
                
                // 更新最后更新时间
                updateLastUpdated();
            }
        }
        
        // 清空输入字段
        function clearInputFields() {
            restaurantNameInput.value = '';
            stallCountInput.value = '';
            inspectionCountInput.value = '';
            generalIssuesInput.value = '';
            seriousIssuesInput.value = '';
            criticalIssuesInput.value = '';
            
            coverageRateSpan.textContent = '0.00';
            issueSeveritySpan.textContent = '0.00';
            compositeScoreSpan.textContent = '0.00';
            
            coverageProgressDiv.style.width = '0%';
            severityProgressDiv.style.width = '0%';
            scoreProgressDiv.style.width = '0%';
            
            scoreProgressDiv.className = 'progress-value bg-success';
            
            restaurantNameInput.focus();
        }
        
        // 重置所有
        function resetAll() {
            if (confirm('确定要重置所有数据吗？这将删除所有餐厅信息。')) {
                // 保存当前统计数据用于计算变化
                saveCurrentStats();
                
                // 重置输入
                clearInputFields();
                
                // 重置设置
                targetCoverageInput.value = '1';
                weightGeneralInput.value = '1';
                weightSeriousInput.value = '3';
                weightCriticalInput.value = '5';
                
                // 更新显示
                updateCoverageTargetDisplay();
                updateWeightDisplays();
                
                // 清空餐厅列表
                restaurants = [];
                
                // 更新统计数据
                updateStatistics();
                
                // 更新表格
                updateRestaurantTable();
                
                // 更新图表
                updateCharts();
                
                // 更新最后更新时间
                updateLastUpdated();
            }
        }
        
        // 导出数据
        function exportData() {
            if (restaurants.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            // 创建CSV内容
            let csvContent = "餐厅名称,档口数,检查次数,一般问题数,较重问题数,严重问题数,问题总数,覆盖充分度,问题严重度,综合评分,整改优先级\n";
            
            restaurants.forEach(restaurant => {
                csvContent += `${restaurant.name},${restaurant.stallCount},${restaurant.inspectionCount},${restaurant.generalIssues},${restaurant.seriousIssues},${restaurant.criticalIssues},${restaurant.totalIssues},${restaurant.coverageRate.toFixed(2)},${restaurant.issueSeverity.toFixed(2)},${restaurant.compositeScore.toFixed(2)},${restaurant.priority.label}优先级\n`;
            });
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `餐厅检查评分数据_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 更新统计数据
        function updateStatistics() {
            // 保存当前统计数据用于计算变化
            saveCurrentStats();
            
            const total = restaurants.length;
            
            // 计算平均值
            let totalScore = 0;
            let totalCoverage = 0;
            let totalSeverity = 0;
            
            restaurants.forEach(r => {
                totalScore += r.compositeScore;
                totalCoverage += r.coverageRate;
                totalSeverity += r.issueSeverity;
            });
            
            const avgScore = total > 0 ? totalScore / total : 0;
            const avgCoverage = total > 0 ? totalCoverage / total : 0;
            const avgSeverity = total > 0 ? totalSeverity / total : 0;
            
            // 更新显示
            totalRestaurantsSpan.textContent = total;
            avgScoreSpan.textContent = avgScore.toFixed(2);
            avgCoverageSpan.textContent = avgCoverage.toFixed(2);
            avgSeveritySpan.textContent = avgSeverity.toFixed(2);
            
            // 更新变化指标
            updateChangeIndicators();
        }
        
        // 保存当前统计数据
        function saveCurrentStats() {
            previousStats = {
                totalRestaurants: parseInt(totalRestaurantsSpan.textContent) || 0,
                avgScore: parseFloat(avgScoreSpan.textContent) || 0,
                avgCoverage: parseFloat(avgCoverageSpan.textContent) || 0,
                avgSeverity: parseFloat(avgSeveritySpan.textContent) || 0
            };
        }
        
        // 更新变化指标
        function updateChangeIndicators() {
            const currentTotal = parseInt(totalRestaurantsSpan.textContent) || 0;
            const currentScore = parseFloat(avgScoreSpan.textContent) || 0;
            const currentCoverage = parseFloat(avgCoverageSpan.textContent) || 0;
            const currentSeverity = parseFloat(avgSeveritySpan.textContent) || 0;
            
            const totalChange = currentTotal - previousStats.totalRestaurants;
            const scoreChange = currentScore - previousStats.avgScore;
            const coverageChange = currentCoverage - previousStats.avgCoverage;
            const severityChange = currentSeverity - previousStats.avgSeverity;
            
            // 更新餐厅数量变化
            if (totalChange > 0) {
                restaurantChangeSpan.textContent = `+${totalChange}`;
                restaurantChangeSpan.className = 'ml-2 text-green-400';
            } else if (totalChange < 0) {
                restaurantChangeSpan.textContent = `${totalChange}`;
                restaurantChangeSpan.className = 'ml-2 text-red-400';
            } else {
                restaurantChangeSpan.textContent = '0';
                restaurantChangeSpan.className = 'ml-2 text-gray-400';
            }
            
            // 更新平均评分变化
            if (scoreChange < 0) {
                scoreChangeSpan.textContent = `${scoreChange.toFixed(2)}`;
                scoreChangeSpan.className = 'ml-2 text-green-400';
            } else if (scoreChange > 0) {
                scoreChangeSpan.textContent = `+${scoreChange.toFixed(2)}`;
                scoreChangeSpan.className = 'ml-2 text-red-400';
            } else {
                scoreChangeSpan.textContent = '0.00';
                scoreChangeSpan.className = 'ml-2 text-gray-400';
            }
            
            // 更新平均覆盖充分度变化
            if (coverageChange > 0) {
                coverageChangeSpan.textContent = `+${coverageChange.toFixed(2)}`;
                coverageChangeSpan.className = 'ml-2 text-green-400';
            } else if (coverageChange < 0) {
                coverageChangeSpan.textContent = `${coverageChange.toFixed(2)}`;
                coverageChangeSpan.className = 'ml-2 text-red-400';
            } else {
                coverageChangeSpan.textContent = '0.00';
                coverageChangeSpan.className = 'ml-2 text-gray-400';
            }
            
            // 更新平均问题严重度变化
            if (severityChange < 0) {
                severityChangeSpan.textContent = `${severityChange.toFixed(2)}`;
                severityChangeSpan.className = 'ml-2 text-green-400';
            } else if (severityChange > 0) {
                severityChangeSpan.textContent = `+${severityChange.toFixed(2)}`;
                severityChangeSpan.className = 'ml-2 text-red-400';
            } else {
                severityChangeSpan.textContent = '0.00';
                severityChangeSpan.className = 'ml-2 text-gray-400';
            }
        }
        
        // 更新温度值显示
        function updateTemperatureValue() {
            temperatureValueSpan.textContent = temperatureSlider.value;
        }
        
        // 显示DeepSeek设置
        function showDeepseekSettings() {
            // 从localStorage加载保存的设置
            loadDeepseekSettings();
            deepseekSettingsModal.classList.remove('hidden');
        }
        
        // 定义各个标准的详细要求和分析规则
        const standardRequirements = {
            '中华人民共和国食品安全法': {
                chapters: [
                    { id: 'foodSafety1', name: '总则', weight: 0.05 },
                    { id: 'foodSafety2', name: '食品安全风险监测和评估', weight: 0.10 },
                    { id: 'foodSafety3', name: '食品安全标准', weight: 0.15 },
                    { id: 'foodSafety4', name: '食品生产经营', weight: 0.30 },
                    { id: 'foodSafety5', name: '食品检验', weight: 0.10 },
                    { id: 'foodSafety6', name: '食品进出口', weight: 0.05 },
                    { id: 'foodSafety7', name: '食品安全事故处置', weight: 0.15 },
                    { id: 'foodSafety8', name: '监督管理', weight: 0.10 }
                ],
                keyRequirements: [
                    '建立健全食品安全管理制度',
                    '确保食品原料符合安全标准',
                    '食品生产经营场所保持清洁',
                    '从业人员持有健康证明',
                    '食品添加剂使用符合标准',
                    '食品标识标签符合规定',
                    '建立食品安全追溯体系',
                    '制定食品安全事故处置方案'
                ]
            },
            '餐饮服务食品安全操作规范': {
                chapters: [
                    { id: 'operation1', name: '餐饮服务场所与设施设备', weight: 0.20 },
                    { id: 'operation2', name: '从业人员卫生管理', weight: 0.15 },
                    { id: 'operation3', name: '食品采购、运输与贮存', weight: 0.20 },
                    { id: 'operation4', name: '食品加工制作', weight: 0.30 },
                    { id: 'operation5', name: '供餐、用餐与配送', weight: 0.05 },
                    { id: 'operation6', name: '清洗消毒', weight: 0.05 },
                    { id: 'operation7', name: '废弃物管理', weight: 0.05 }
                ],
                keyRequirements: [
                    '食品处理区划分合理',
                    '冷藏冷冻设施运转正常',
                    '从业人员操作规范',
                    '食品原料分类存放',
                    '烹饪过程温度控制',
                    '餐饮具清洗消毒符合要求',
                    '防蝇防鼠设施完善',
                    '废弃物分类存放'
                ]
            },
            'ISO 9001质量管理体系': {
                chapters: [
                    { id: 'iso9001_1', name: '质量管理体系策划', weight: 0.15 },
                    { id: 'iso9001_2', name: '资源管理', weight: 0.15 },
                    { id: 'iso9001_3', name: '产品实现', weight: 0.30 },
                    { id: 'iso9001_4', name: '测量、分析和改进', weight: 0.20 },
                    { id: 'iso9001_5', name: '管理评审', weight: 0.20 }
                ],
                keyRequirements: [
                    '制定质量方针和质量目标',
                    '建立文件化的质量管理体系',
                    '定期进行内部审核',
                    '识别和管理过程风险',
                    '收集和分析质量数据',
                    '实施持续改进',
                    '关注顾客满意',
                    '管理评审有效性'
                ]
            },
            'HACCP食品风险控制点体系': {
                chapters: [
                    { id: 'haccp1', name: '危害分析', weight: 0.25 },
                    { id: 'haccp2', name: '关键控制点确定', weight: 0.25 },
                    { id: 'haccp3', name: '关键限值建立', weight: 0.15 },
                    { id: 'haccp4', name: '监控系统建立', weight: 0.15 },
                    { id: 'haccp5', name: '纠偏措施制定', weight: 0.10 },
                    { id: 'haccp6', name: '验证程序实施', weight: 0.10 }
                ],
                keyRequirements: [
                    '识别生物、化学、物理危害',
                    '确定关键控制点',
                    '建立关键限值',
                    '实施监控措施',
                    '制定纠偏计划',
                    '进行验证活动',
                    '建立记录保持系统',
                    '定期进行HACCP计划评审'
                ]
            }
        };
        
        // 根据标准执行详细分析
        function analyzeByStandard(restaurantData, standards) {
            const analysisResults = {};
            
            standards.forEach(standard => {
                const requirements = standardRequirements[standard];
                if (!requirements) return;
                
                let totalScore = 0;
                let totalWeight = 0;
                const chapterScores = {};
                
                // 分析各章节评分
                requirements.chapters.forEach(chapter => {
                    // 根据餐厅数据计算章节得分（模拟）
                    let chapterScore = 100 - (calculateIssuesImpact(restaurantData) * chapter.weight);
                    chapterScore = Math.max(0, Math.min(100, chapterScore));
                    
                    chapterScores[chapter.id] = {
                        name: chapter.name,
                        score: chapterScore,
                        weight: chapter.weight
                    };
                    
                    totalScore += chapterScore * chapter.weight;
                    totalWeight += chapter.weight;
                });
                
                // 综合评分
                const finalScore = totalWeight > 0 ? totalScore / totalWeight : 0;
                
                // 生成合规性评估
                let complianceStatus = '完全合规';
                if (finalScore < 60) {
                    complianceStatus = '严重不合规';
                } else if (finalScore < 80) {
                    complianceStatus = '部分合规';
                }
                
                analysisResults[standard] = {
                    score: finalScore,
                    complianceStatus: complianceStatus,
                    chapterScores: chapterScores,
                    keyIssues: identifyKeyIssues(restaurantData, requirements.keyRequirements),
                    improvementSuggestions: generateImprovementSuggestions(restaurantData, standard)
                };
            });
            
            return analysisResults;
        }
        
        // 计算问题对评分的影响
        function calculateIssuesImpact(data) {
            // 根据问题数量和严重程度计算影响分数
            const impact = data.generalIssues * 2 + data.seriousIssues * 8 + data.criticalIssues * 20;
            return impact;
        }
        
        // 识别关键问题
        function identifyKeyIssues(data, keyRequirements) {
            // 模拟基于要求和问题数量的关键问题识别
            const issues = [];
            
            if (data.criticalIssues > 0) {
                issues.push(keyRequirements[0]); // 管理制度问题
            }
            if (data.seriousIssues > 2) {
                issues.push(keyRequirements[1]); // 原料标准问题
            }
            if (data.generalIssues > 5) {
                issues.push(keyRequirements[2]); // 场所清洁问题
            }
            
            return issues;
        }
        
        // 生成改进建议
        function generateImprovementSuggestions(data, standard) {
            const suggestions = [];
            
            // 根据不同标准生成有针对性的建议
            switch(standard) {
                case '中华人民共和国食品安全法':
                    suggestions.push('加强食品安全管理制度建设，确保符合最新法律法规要求');
                    suggestions.push('完善食品原料采购验收程序，严格落实索证索票制度');
                    suggestions.push('定期组织员工学习食品安全法相关知识，提高法律意识');
                    break;
                case '餐饮服务食品安全操作规范':
                    suggestions.push('优化食品处理区布局，确保流程合理，防止交叉污染');
                    suggestions.push('加强设备设施维护保养，确保正常运行和卫生状况');
                    suggestions.push('规范从业人员操作行为，严格执行洗手消毒等卫生要求');
                    break;
                case 'ISO 9001质量管理体系':
                    suggestions.push('完善质量管理体系文件，确保覆盖所有关键过程');
                    suggestions.push('加强内部审核和管理评审，持续改进质量管理绩效');
                    suggestions.push('建立数据收集和分析机制，用于决策和改进');
                    break;
                case 'HACCP食品风险控制点体系':
                    suggestions.push('全面识别食品加工过程中的危害，确定关键控制点');
                    suggestions.push('建立有效的监控系统，确保关键限值得到满足');
                    break;
            }
            
            // 根据问题数量添加通用建议
            if (data.criticalIssues > 0) {
                suggestions.push('立即整改严重问题，消除重大风险隐患');
            }
            if (data.seriousIssues > 0) {
                suggestions.push('制定详细的整改计划，明确责任人，按时完成整改');
            }
            
            return suggestions;
        }
        
        // 保存DeepSeek设置
        function saveDeepseekSettings() {
            const settings = {
                apiKey: deepseekApiKeyInput.value,
                analysisMode: analysisModeSelect.value,
                standards: [
                    document.getElementById('standardFoodSafety').checked,
                    document.getElementById('standardOperation').checked,
                    document.getElementById('standardIso9001').checked,
                    document.getElementById('standardHaccp').checked
                ],
                temperature: parseFloat(temperatureSlider.value)
            };
            
            localStorage.setItem('deepseekSettings', JSON.stringify(settings));
            alert('设置已保存');
            deepseekSettingsModal.classList.add('hidden');
        }
        
        // 加载DeepSeek设置
        function loadDeepseekSettings() {
            const savedSettings = localStorage.getItem('deepseekSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    deepseekApiKeyInput.value = settings.apiKey || '';
                    analysisModeSelect.value = settings.analysisMode || 'standard';
                    
                    if (settings.standards) {
                        document.getElementById('standardFoodSafety').checked = settings.standards[0] !== false;
                        document.getElementById('standardOperation').checked = settings.standards[1] !== false;
                        document.getElementById('standardIso9001').checked = settings.standards[2] !== false;
                        document.getElementById('standardHaccp').checked = settings.standards[3] !== false;
                    }
                    
                    if (settings.temperature !== undefined) {
                        temperatureSlider.value = settings.temperature;
                        temperatureValueSpan.textContent = settings.temperature;
                    }
                } catch (e) {
                    console.error('加载设置失败:', e);
                }
            }
        }
        
        // 运行DeepSeek分析
        async function runDeepseekAnalysis() {
            // 检查是否有餐厅数据
            if (restaurants.length === 0) {
                alert('请先添加餐厅数据');
                return;
            }
            
            // 加载设置
            loadDeepseekSettings();
            
            // 验证API Key
            const apiKey = deepseekApiKeyInput.value;
            if (!apiKey) {
                alert('请先输入API Key');
                deepseekSettingsModal.classList.remove('hidden');
                return;
            }
            
            // 准备分析数据
            const analysisData = prepareAnalysisData();
            
            // 显示加载状态
            aiAnalysisResultDiv.innerHTML = `
                <div class="text-center text-gray-400 py-10">
                    <i class="fa fa-circle-o-notch fa-spin text-4xl mb-3 text-purple-400"></i>
                    <p>正在进行AI深度分析，请稍候...</p>
                </div>
            `;
            aiAnalysisSection.classList.remove('hidden');
            
            try {
                // 调用DeepSeek API
                const result = await callDeepseekApi(analysisData, apiKey);
                
                // 显示分析结果
                displayAnalysisResult(result);
                
                // 更新分析时间
                const now = new Date();
                analysisTimeSpan.textContent = `分析时间: ${now.toLocaleString('zh-CN')}`;
                
                // 显示操作按钮
                generatePdfBtn.classList.remove('hidden');
                regenerateAnalysisBtn.classList.remove('hidden');
                
            } catch (error) {
                console.error('分析失败:', error);
                aiAnalysisResultDiv.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <i class="fa fa-exclamation-triangle text-4xl mb-3 text-red-400"></i>
                        <p>分析失败</p>
                        <p class="text-sm mt-2">${error.message || '请检查API Key是否正确'}</p>
                    </div>
                `;
            }
        }
        
        // 准备分析数据
        function prepareAnalysisData() {
            // 获取选中的标准
            const selectedStandards = [];
            if (document.getElementById('standard1').checked) selectedStandards.push('中华人民共和国食品安全法');
            if (document.getElementById('standard2').checked) selectedStandards.push('餐饮服务食品安全操作规范');
            if (document.getElementById('standard3').checked) selectedStandards.push('9001质量管理体系');
            if (document.getElementById('standard4').checked) selectedStandards.push('HACCP食品风险控制点体系');
            
            return {
                restaurants: restaurants,
                analysisMode: analysisModeSelect.value,
                standards: selectedStandards,
                temperature: parseFloat(temperatureSlider.value),
                weights: {
                    general: parseInt(weightGeneralInput.value),
                    serious: parseInt(weightSeriousInput.value),
                    critical: parseInt(weightCriticalInput.value)
                },
                targetCoverage: parseFloat(targetCoverageInput.value)
            };
        }
        
        // 调用DeepSeek API
        async function callDeepseekApi(data, apiKey) {
            // 构造提示词
            const prompt = generateAnalysisPrompt(data);
            
            // 由于这是模拟环境，我们返回模拟数据
            // 在实际环境中，这里应该调用真实的API
            return await simulateDeepseekAnalysis(data);
        }
        
        // 生成分析提示词
        function generateAnalysisPrompt(data) {
            let prompt = `请作为餐饮安全专家，根据以下餐厅检查数据进行深度分析，并依据${data.standards.join('、')}提供专业建议。\n\n`;
            
            prompt += `分析模式：${getAnalysisModeText(data.analysisMode)}\n\n`;
            
            prompt += `权重设置：\n`;
            prompt += `- 一般问题权重：${data.weights.general}\n`;
            prompt += `- 较重问题权重：${data.weights.serious}\n`;
            prompt += `- 严重问题权重：${data.weights.critical}\n\n`;
            
            prompt += `目标覆盖值：${data.targetCoverage}次/档口\n\n`;
            
            prompt += `餐厅数据：\n`;
            data.restaurants.forEach(restaurant => {
                prompt += `- ${restaurant.name}\n`;
                prompt += `  档口数：${restaurant.stallCount}\n`;
                prompt += `  检查次数：${restaurant.inspectionCount}\n`;
                prompt += `  问题：一般${restaurant.generalIssues}个，较重${restaurant.seriousIssues}个，严重${restaurant.criticalIssues}个\n`;
                prompt += `  覆盖充分度：${restaurant.coverageRate.toFixed(2)}\n`;
                prompt += `  问题严重度：${restaurant.issueSeverity.toFixed(2)}\n`;
                prompt += `  综合评分：${restaurant.compositeScore.toFixed(2)}\n\n`;
            });
            
            prompt += `请提供以下内容：\n`;
            prompt += `1. 整体数据分析和风险评估\n`;
            prompt += `2. 各餐厅存在的主要问题\n`;
            prompt += `3. 基于相关法规标准的改进建议\n`;
            prompt += `4. 优先级排序和整改计划\n`;
            
            return prompt;
        }
        
        // 获取分析模式文本
        function getAnalysisModeText(mode) {
            switch(mode) {
                case 'standard': return '标准分析';
                case 'detailed': return '详细分析';
                case 'comprehensive': return '全面分析（包含法规依据）';
                default: return '标准分析';
            }
        }
        
        // 模拟DeepSeek分析（演示用）
        async function simulateDeepseekAnalysis(data) {
            // 模拟API延迟
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 生成模拟分析结果
            let result = '';
            
            // 整体数据分析
            const totalRestaurants = data.restaurants.length;
            const avgScore = data.restaurants.reduce((sum, r) => sum + r.compositeScore, 0) / totalRestaurants;
            const highPriorityCount = data.restaurants.filter(r => r.compositeScore >= 2).length;
            
            result += `<h3 class="text-lg font-semibold text-purple-400 mb-4">1. 整体数据分析与风险评估</h3>`;
            result += `<div class="bg-dark-400/50 p-4 rounded-lg mb-6">`;
            result += `<p class="mb-3">根据${data.standards.join('、')}的标准，共分析了${totalRestaurants}家餐厅的检查数据。</p>`;
            result += `<p class="mb-3">整体平均综合评分为<span class="text-${avgScore >= 2 ? 'red' : avgScore >= 1 ? 'yellow' : 'green'}-400 font-medium">${avgScore.toFixed(2)}</span>，`;
            result += `其中<span class="text-red-400 font-medium">${highPriorityCount}</span>家餐厅需要高优先级整改。</p>`;
            
            if (highPriorityCount > totalRestaurants * 0.3) {
                result += `<p class="text-red-400">⚠️ 警告：超过30%的餐厅存在严重问题，整体食品安全风险较高。</p>`;
            } else if (highPriorityCount === 0) {
                result += `<p class="text-green-400">✅ 良好：所有餐厅均符合基本安全标准。</p>`;
            }
            result += `</div>`;
            
            // 各餐厅分析
            result += `<h3 class="text-lg font-semibold text-purple-400 mb-4">2. 各餐厅问题分析</h3>`;
            data.restaurants.forEach(restaurant => {
                const riskLevel = restaurant.compositeScore >= 2 ? '高' : restaurant.compositeScore >= 1 ? '中' : '低';
                const riskColor = restaurant.compositeScore >= 2 ? 'red' : restaurant.compositeScore >= 1 ? 'yellow' : 'green';
                
                result += `<div class="mb-5">`;
                result += `<h4 class="flex items-center text-${riskColor}-400 font-medium mb-2">`;
                result += `<i class="fa fa-utensils mr-2"></i>${restaurant.name} `;
                result += `<span class="ml-2 text-xs px-2 py-1 bg-${riskColor}-400/20 text-${riskColor}-400 rounded">`;
                result += `${riskLevel}风险`;
                result += `</span>`;
                result += `</h4>`;
                
                result += `<div class="bg-dark-400/30 p-3 rounded pl-6">`;
                
                // 覆盖充分度问题
                if (restaurant.coverageRate < data.targetCoverage * 0.8) {
                    result += `<p class="text-yellow-400 mb-2">⚠️ 检查覆盖不足：当前覆盖率${restaurant.coverageRate.toFixed(2)}次/档口，`;
                    result += `低于目标值的80%。建议增加检查频次。</p>`;
                }
                
                // 问题严重度分析
                if (restaurant.criticalIssues > 0) {
                    result += `<p class="text-red-400 mb-2">🚨 存在严重问题：共${restaurant.criticalIssues}个严重问题，`;
                    result += `违反《中华人民共和国食品安全法》相关规定，需立即整改。</p>`;
                } else if (restaurant.seriousIssues > restaurant.stallCount) {
                    result += `<p class="text-yellow-400 mb-2">⚠️ 较重问题较多：平均每档口${(restaurant.seriousIssues / restaurant.stallCount).toFixed(1)}个较重问题，`;
                    result += `需加强管理。</p>`;
                }
                
                // 具体改进建议
                if (restaurant.compositeScore >= 2) {
                    result += `<p class="text-gray-300 mb-2">🔧 改进建议：</p>`;
                    result += `<ul class="list-disc pl-5 text-sm text-gray-400 mb-2">`;
                    result += `<li>立即停止使用存在严重问题的设备或原料</li>`;
                    result += `<li>组织全体员工进行食品安全培训</li>`;
                    result += `<li>聘请专业顾问进行全面审计</li>`;
                    result += `</ul>`;
                } else if (restaurant.compositeScore >= 1) {
                    result += `<p class="text-gray-300 mb-2">💡 优化建议：</p>`;
                    result += `<ul class="list-disc pl-5 text-sm text-gray-400 mb-2">`;
                    result += `<li>建立每日检查制度</li>`;
                    result += `<li>完善食品安全操作规程</li>`;
                    result += `</ul>`;
                }
                
                result += `</div>`;
                result += `</div>`;
            });
            
            // 法规依据和建议
            result += `<h3 class="text-lg font-semibold text-purple-400 mb-4">3. 法规依据与改进建议</h3>`;
            result += `<div class="bg-dark-400/50 p-4 rounded-lg mb-6">`;
            
            // 根据选中的标准提供不同的建议
            if (data.standards.includes('中华人民共和国食品安全法')) {
                result += `<h4 class="text-white font-medium mb-2">《中华人民共和国食品安全法》相关要求：</h4>`;
                result += `<ul class="list-disc pl-5 text-sm text-gray-300 mb-3">`;
                result += `<li>第三十三条规定：食品生产经营应当符合食品安全标准，并符合下列要求...</li>`;
                result += `<li>第一百二十六条规定：违反本法规定，有下列情形之一的，由县级以上人民政府食品安全监督管理部门...</li>`;
                result += `</ul>`;
            }
            
            if (data.standards.includes('餐饮服务食品安全操作规范')) {
                result += `<h4 class="text-white font-medium mb-2">《餐饮服务食品安全操作规范》相关要求：</h4>`;
                result += `<ul class="list-disc pl-5 text-sm text-gray-300 mb-3">`;
                result += `<li>应建立健全食品安全管理制度，明确食品安全责任，落实岗位责任制</li>`;
                result += `<li>从业人员应保持良好的个人卫生，操作前应洗净手部，操作时应穿戴清洁的工作衣帽</li>`;
                result += `</ul>`;
            }
            
            if (data.standards.includes('9001质量管理体系')) {
                result += `<h4 class="text-white font-medium mb-2">ISO 9001质量管理体系相关要求：</h4>`;
                result += `<ul class="list-disc pl-5 text-sm text-gray-300 mb-3">`;
                result += `<li>应建立文件化的质量管理体系，明确各过程的输入、输出和控制要求</li>`;
                result += `<li>应定期进行内部审核和管理评审，持续改进质量管理体系的有效性</li>`;
                result += `</ul>`;
            }
            
            if (data.standards.includes('HACCP食品风险控制点体系')) {
                result += `<h4 class="text-white font-medium mb-2">HACCP食品风险控制点体系相关要求：</h4>`;
                result += `<ul class="list-disc pl-5 text-sm text-gray-300 mb-3">`;
                result += `<li>应对食品生产经营过程中的危害进行分析，确定关键控制点</li>`;
                result += `<li>应对关键控制点进行监控，建立纠正和预防措施</li>`;
                result += `</ul>`;
            }
            
            result += `</div>`;
            
            // 整改计划
            result += `<h3 class="text-lg font-semibold text-purple-400 mb-4">4. 整改计划与优先级排序</h3>`;
            result += `<div class="bg-dark-400/50 p-4 rounded-lg">`;
            
            // 按综合评分排序
            const sortedRestaurants = [...data.restaurants].sort((a, b) => b.compositeScore - a.compositeScore);
            
            result += `<p class="mb-3">根据分析结果，建议按以下优先级进行整改：</p>`;
            result += `<table class="w-full text-sm">`;
            result += `<thead>`;
            result += `<tr class="border-b border-dark-300">`;
            result += `<th class="text-left py-2 px-3">优先级</th>`;
            result += `<th class="text-left py-2 px-3">餐厅名称</th>`;
            result += `<th class="text-left py-2 px-3">综合评分</th>`;
            result += `<th class="text-left py-2 px-3">整改期限</th>`;
            result += `</tr>`;
            result += `</thead>`;
            result += `<tbody>`;
            
            sortedRestaurants.forEach((restaurant, index) => {
                let deadline = '立即';
                if (restaurant.compositeScore < 2) deadline = '7天内';
                if (restaurant.compositeScore < 1) deadline = '30天内';
                
                result += `<tr class="border-b border-dark-300">`;
                result += `<td class="py-2 px-3">${index + 1}</td>`;
                result += `<td class="py-2 px-3 font-medium">${restaurant.name}</td>`;
                result += `<td class="py-2 px-3 text-${restaurant.compositeScore >= 2 ? 'red' : restaurant.compositeScore >= 1 ? 'yellow' : 'green'}-400">${restaurant.compositeScore.toFixed(2)}</td>`;
                result += `<td class="py-2 px-3">${deadline}</td>`;
                result += `</tr>`;
            });
            
            result += `</tbody>`;
            result += `</table>`;
            
            result += `<p class="mt-4 text-sm text-gray-400">注：高优先级餐厅（评分≥2）需立即整改并在3个工作日内提交整改报告；中优先级餐厅（评分1-2）需在7天内完成整改；低优先级餐厅（评分<1）需在30天内完成优化。</p>`;
            
            result += `</div>`;
            
            return result;
        }
        
        // 显示分析结果
        function displayAnalysisResult(result) {
            aiAnalysisResultDiv.innerHTML = result;
        }
        
        // 生成分析报告PDF
        function generateAnalysisPdfReport() {
            alert('PDF生成功能即将实现');
            // 后续会实现完整的PDF生成逻辑
        }
        
        // 初始化图表
        function initCharts() {
            // 综合评分柱状图
            const scoreBarCtx = document.getElementById('scoreBarChart').getContext('2d');
            scoreBarChart = new Chart(scoreBarCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '综合评分',
                        data: [],
                        backgroundColor: [],
                        borderColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 5,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            title: {
                                display: true,
                                text: '综合评分',
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `综合评分: ${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // 餐厅多维度指标雷达图
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: [
                        '覆盖充分度',
                        '问题严重度',
                        '综合评分',
                        '问题总数',
                        '整改优先级'
                    ],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '餐厅多维度表现对比',
                            color: '#d1d5db'
                        },
                        legend: {
                            labels: {
                                color: '#9ca3af'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            pointLabels: {
                                color: '#9ca3af'
                            },
                            ticks: {
                                color: '#9ca3af',
                                backdropColor: 'transparent',
                                showLabelBackdrop: false
                            }
                        }
                    }
                }
            });
        }
        
        // 更新图表
        function updateCharts() {
            // 更新柱状图
            scoreBarChart.data.labels = restaurants.map(r => r.name);
            scoreBarChart.data.datasets[0].data = restaurants.map(r => r.compositeScore);
            
            // 设置柱状图颜色
            const barColors = restaurants.map(r => {
                if (r.compositeScore >= 2) return '#ef4444'; // 红色
                if (r.compositeScore >= 1) return '#f59e0b'; // 黄色
                return '#10b981'; // 绿色
            });
            
            scoreBarChart.data.datasets[0].backgroundColor = barColors;
            scoreBarChart.data.datasets[0].borderColor = barColors;
            
            // 更新雷达图（只显示评分最高和最低的餐厅，以及平均水平）
            const radarDatasets = [];
            
            // 添加平均水平数据集
            if (restaurants.length > 0) {
                const avgCoverageRate = restaurants.reduce((sum, r) => sum + r.coverageRate, 0) / restaurants.length;
                const avgIssueSeverity = restaurants.reduce((sum, r) => sum + r.issueSeverity, 0) / restaurants.length;
                const avgCompositeScore = restaurants.reduce((sum, r) => sum + r.compositeScore, 0) / restaurants.length;
                const avgTotalIssues = restaurants.reduce((sum, r) => sum + r.totalIssues, 0) / restaurants.length;
                const maxIssues = Math.max(...restaurants.map(r => r.totalIssues));
                
                radarDatasets.push({
                    label: '平均水平',
                    data: [
                        Math.min(avgCoverageRate, 2), // 归一化
                        avgIssueSeverity,
                        avgCompositeScore,
                        avgTotalIssues / maxIssues * 5, // 归一化
                        avgCompositeScore
                    ],
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointHoverBackgroundColor: '#ffffff',
                    pointHoverBorderColor: '#6366f1'
                });
            }
            
            // 添加评分最低的餐厅
            if (restaurants.length > 0) {
                const worstRestaurant = [...restaurants].sort((a, b) => b.compositeScore - a.compositeScore)[0];
                const maxIssues = Math.max(...restaurants.map(r => r.totalIssues));
                
                radarDatasets.push({
                    label: `${worstRestaurant.name} (需整改)`,
                    data: [
                        Math.min(worstRestaurant.coverageRate, 2), // 归一化
                        worstRestaurant.issueSeverity,
                        worstRestaurant.compositeScore,
                        (worstRestaurant.totalIssues / maxIssues) * 5, // 归一化
                        worstRestaurant.compositeScore
                    ],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#ffffff',
                    pointHoverBackgroundColor: '#ffffff',
                    pointHoverBorderColor: '#ef4444'
                });
            }
            
            // 添加评分最高的餐厅
            if (restaurants.length > 1) {
                const bestRestaurant = [...restaurants].sort((a, b) => a.compositeScore - b.compositeScore)[0];
                const maxIssues = Math.max(...restaurants.map(r => r.totalIssues));
                
                radarDatasets.push({
                    label: `${bestRestaurant.name} (优秀)`,
                    data: [
                        Math.min(bestRestaurant.coverageRate, 2), // 归一化
                        bestRestaurant.issueSeverity,
                        bestRestaurant.compositeScore,
                        (bestRestaurant.totalIssues / maxIssues) * 5, // 归一化
                        bestRestaurant.compositeScore
                    ],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#ffffff',
                    pointHoverBackgroundColor: '#ffffff',
                    pointHoverBorderColor: '#10b981'
                });
            }
            
            radarChart.data.datasets = radarDatasets;
            
            // 更新图表
            scoreBarChart.update();
            radarChart.update();
        }
        
        // 初始化粒子背景
        function initParticlesBackground() {
            const canvas = document.createElement('canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.getElementById('particles-bg').appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const particles = [];
            const particleCount = 80;

            // 创建粒子
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5 + 0.5,
                    color: `rgba(${Math.floor(Math.random()*80+180)}, ${Math.floor(Math.random()*80+180)}, ${Math.floor(Math.random()*80+180)}, 0.5)`,
                    speedX: Math.random() * 0.3 - 0.15,
                    speedY: Math.random() * 0.3 - 0.15
                });
            }

            // 鼠标位置追踪
            let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            
                particles.forEach(p => {
                    // 更新位置
                    p.x += p.speedX;
                    p.y += p.speedY;
                
                    // 边界检查
                    if (p.x > canvas.width) p.x = 0;
                    if (p.x < 0) p.x = canvas.width;
                    if (p.y > canvas.height) p.y = 0;
                    if (p.y < 0) p.y = canvas.height;
                
                    // 鼠标交互 - 靠近鼠标的粒子微微偏移
                    const dx = p.x - mouseX;
                    const dy = p.y - mouseY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 100) {
                        p.x += dx * 0.01;
                        p.y += dy * 0.01;
                    }
                
                    // 绘制粒子
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
            
                // 连接临近粒子
                connectParticles();
            }

            // 连接临近的粒子
            function connectParticles() {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                    
                        if (dist < 120) {
                            ctx.beginPath();
                            ctx.strokeStyle = `rgba(100, 150, 255, ${0.15 * (1 - dist/120)})`;
                            ctx.lineWidth = 0.5;
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.stroke();
                        }
                    }
                }
            }

            // 启动动画
            animate();

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
        
        // 添加示例数据
        function addExampleData() {
            const exampleRestaurants = [
                {
                    name: '幸福餐厅',
                    stallCount: 5,
                    inspectionCount: 6,
                    generalIssues: 3,
                    seriousIssues: 1,
                    criticalIssues: 0
                },
                {
                    name: '美味轩',
                    stallCount: 3,
                    inspectionCount: 3,
                    generalIssues: 5,
                    seriousIssues: 2,
                    criticalIssues: 1
                },
                {
                    name: '快乐厨房',
                    stallCount: 4,
                    inspectionCount: 8,
                    generalIssues: 1,
                    seriousIssues: 0,
                    criticalIssues: 0
                },
                {
                    name: '健康食府',
                    stallCount: 6,
                    inspectionCount: 4,
                    generalIssues: 4,
                    seriousIssues: 3,
                    criticalIssues: 1
                },
                {
                    name: '阳光餐厅',
                    stallCount: 2,
                    inspectionCount: 2,
                    generalIssues: 0,
                    seriousIssues: 0,
                    criticalIssues: 0
                }
            ];
            
            // 获取权重
            const weightGeneral = parseInt(weightGeneralInput.value) || 1;
            const weightSerious = parseInt(weightSeriousInput.value) || 3;
            const weightCritical = parseInt(weightCriticalInput.value) || 5;
            
            // 获取目标覆盖值
            const targetCoverage = parseFloat(targetCoverageInput.value) || 1;
            
            // 添加示例餐厅
            exampleRestaurants.forEach(example => {
                const coverageRate = example.inspectionCount / example.stallCount;
                const totalIssueScore = (example.generalIssues * weightGeneral) + 
                                       (example.seriousIssues * weightSerious) + 
                                       (example.criticalIssues * weightCritical);
                const issueSeverity = totalIssueScore / example.stallCount;
                const coverageFactor = 1 - (coverageRate / targetCoverage);
                const compositeScore = (issueSeverity * 0.7) + (coverageFactor * 0.3);
                
                restaurants.push({
                    id: Date.now() + Math.floor(Math.random() * 1000),
                    name: example.name,
                    stallCount: example.stallCount,
                    inspectionCount: example.inspectionCount,
                    generalIssues: example.generalIssues,
                    seriousIssues: example.seriousIssues,
                    criticalIssues: example.criticalIssues,
                    totalIssues: example.generalIssues + example.seriousIssues + example.criticalIssues,
                    coverageRate,
                    issueSeverity,
                    compositeScore,
                    priority: getPriority(compositeScore)
                });
            });
            
            // 更新统计数据
            updateStatistics();
            
            // 排序餐厅
            sortRestaurants();
            
            // 更新表格
            updateRestaurantTable();
            
            // 更新图表
            updateCharts();
        }
        
        // PDF上传和分析相关功能
        const pdfUploadBtn = document.getElementById('pdfUploadBtn');
        const pdfUploadModal = document.getElementById('pdfUploadModal');
        const closePdfUploadModal = document.getElementById('closePdfUploadModal');
        const cancelPdfUploadBtn = document.getElementById('cancelPdfUploadBtn');
        const pdfDropZone = document.getElementById('pdfDropZone');
        const pdfFileInput = document.getElementById('pdfFileInput');
        const startAnalysisBtn = document.getElementById('startAnalysisBtn');
        const pdfAnalysisResultModal = document.getElementById('pdfAnalysisResultModal');
        const closePdfResultModal = document.getElementById('closePdfResultModal');
        const pdfAnalysisLoading = document.getElementById('pdfAnalysisLoading');
        const pdfAnalysisContent = document.getElementById('pdfAnalysisContent');
        const pdfFileName = document.getElementById('pdfFileName');
        const pdfAnalysisTime = document.getElementById('pdfAnalysisTime');
        const complianceResult = document.getElementById('complianceResult');
        const issuesList = document.getElementById('issuesList');
        const pdfSuggestions = document.getElementById('pdfSuggestions');
        const downloadPdfReportBtn = document.getElementById('downloadPdfReportBtn');
        const addDataBtn = document.getElementById('addDataBtn');
        
        // 当前上传的PDF文件
        let currentPdfFile = null;
        
        // PDF上传模态框事件处理
        pdfUploadBtn.addEventListener('click', () => {
            pdfUploadModal.classList.remove('hidden');
        });
        
        function closePdfUpload() {
            pdfUploadModal.classList.add('hidden');
            // 重置表单
            pdfFileInput.value = '';
            currentPdfFile = null;
            startAnalysisBtn.disabled = true;
            pdfDropZone.classList.remove('border-primary');
        }
        
        closePdfUploadModal.addEventListener('click', closePdfUpload);
        cancelPdfUploadBtn.addEventListener('click', closePdfUpload);
        
        // PDF拖放区域处理
        pdfDropZone.addEventListener('click', () => {
            pdfFileInput.click();
        });
        
        pdfFileInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files[0]);
        });
        
        pdfDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfDropZone.classList.add('border-primary');
        });
        
        pdfDropZone.addEventListener('dragleave', () => {
            pdfDropZone.classList.remove('border-primary');
        });
        
        pdfDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfDropZone.classList.remove('border-primary');
            if (e.dataTransfer.files.length > 0) {
                handleFileSelection(e.dataTransfer.files[0]);
            }
        });
        
        // 处理文件选择
        function handleFileSelection(file) {
            if (!file || !file.name.endsWith('.pdf')) {
                alert('请选择PDF格式的文件');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('文件大小不能超过10MB');
                return;
            }
            
            currentPdfFile = file;
            startAnalysisBtn.disabled = false;
            // 显示文件已选择的视觉反馈
            pdfDropZone.classList.add('border-green-400');
            setTimeout(() => {
                pdfDropZone.classList.remove('border-green-400');
            }, 2000);
        }
        
        // 开始分析
        startAnalysisBtn.addEventListener('click', async () => {
            if (!currentPdfFile) return;
            
            // 关闭上传模态框
            pdfUploadModal.classList.add('hidden');
            
            // 显示结果模态框和加载状态
            pdfAnalysisResultModal.classList.remove('hidden');
            pdfAnalysisLoading.classList.remove('hidden');
            pdfAnalysisContent.classList.add('hidden');
            
            // 获取选中的分析标准
            const standards = [];
            if (document.getElementById('standardFoodSafety').checked) {
                standards.push('中华人民共和国食品安全法');
            }
            if (document.getElementById('standardOperation').checked) {
                standards.push('餐饮服务食品安全操作规范');
            }
            if (document.getElementById('standardIso9001').checked) {
                standards.push('ISO 9001质量管理体系');
            }
            if (document.getElementById('standardHaccp').checked) {
                standards.push('HACCP食品风险控制点体系');
            }
            
            try {
                // 模拟PDF分析过程
                await simulatePdfAnalysis(currentPdfFile, standards);
                
                // 显示分析结果
                pdfAnalysisLoading.classList.add('hidden');
                pdfAnalysisContent.classList.remove('hidden');
                
            } catch (error) {
                console.error('PDF分析出错:', error);
                alert('PDF分析失败，请重试');
                pdfAnalysisResultModal.classList.add('hidden');
            }
        });
        
        // 模拟PDF分析（演示用）
        async function simulatePdfAnalysis(file, standards) {
            // 模拟分析延迟
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 设置文件信息
            pdfFileName.textContent = file.name;
            pdfAnalysisTime.textContent = new Date().toLocaleString('zh-CN');
            
            // 生成模拟合规性分析结果
            complianceResult.innerHTML = '';
            standards.forEach(standard => {
                const complianceLevel = Math.random();
                let status = '';
                let color = '';
                let icon = '';
                
                if (complianceLevel < 0.3) {
                    status = '严重不合规';
                    color = 'text-red-400';
                    icon = 'fa-exclamation-circle';
                } else if (complianceLevel < 0.6) {
                    status = '部分不合规';
                    color = 'text-yellow-400';
                    icon = 'fa-exclamation-triangle';
                } else {
                    status = '基本合规';
                    color = 'text-green-400';
                    icon = 'fa-check-circle';
                }
                
                const complianceItem = document.createElement('div');
                complianceItem.className = 'bg-dark-400/50 p-4 rounded-lg';
                complianceItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h5 class="font-medium text-white">${standard}</h5>
                        <span class="flex items-center ${color}">
                            <i class="fa ${icon} mr-1"></i> ${status}
                        </span>
                    </div>
                    <div class="mt-2 w-full bg-dark-400 rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full" style="width: ${Math.min(100, (1 - complianceLevel) * 100)}%"></div>
                    </div>
                `;
                complianceResult.appendChild(complianceItem);
            });
            
            // 生成模拟问题列表
            issuesList.innerHTML = '';
            const issueTypes = [
                '食品原料储存不当，存在过期风险',
                '操作台面清洁不彻底',
                '部分员工未佩戴工作帽和口罩',
                '食品处理区和非食品处理区交叉污染',
                '餐具消毒不规范',
                '食品留样制度未严格执行',
                '冰箱温度记录不完整',
                '排水设施存在堵塞现象',
                '垃圾处理不及时，存在异味',
                '人员健康证管理不完善'
            ];
            
            const selectedIssues = [];
            for (let i = 0; i < 5; i++) {
                const randomIndex = Math.floor(Math.random() * issueTypes.length);
                if (!selectedIssues.includes(randomIndex)) {
                    selectedIssues.push(randomIndex);
                }
            }
            
            selectedIssues.forEach(index => {
                const issueSeverity = Math.random();
                let severityClass = '';
                let severityText = '';
                
                if (issueSeverity < 0.33) {
                    severityClass = 'bg-green-400/20 text-green-400';
                    severityText = '一般';
                } else if (issueSeverity < 0.66) {
                    severityClass = 'bg-yellow-400/20 text-yellow-400';
                    severityText = '较重';
                } else {
                    severityClass = 'bg-red-400/20 text-red-400';
                    severityText = '严重';
                }
                
                const issueItem = document.createElement('div');
                issueItem.className = 'flex items-start p-3 bg-dark-400/30 rounded-lg';
                issueItem.innerHTML = `
                    <div class="mt-1 mr-3">
                        <i class="fa fa-times-circle text-red-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-gray-300 mb-1">${issueTypes[index]}</p>
                        <span class="text-xs px-2 py-1 rounded-full ${severityClass}">${severityText}</span>
                    </div>
                `;
                issuesList.appendChild(issueItem);
            });
            
            // 设置整改建议
            pdfSuggestions.textContent = 
                '1. 建立健全食品安全管理制度，明确各岗位责任；\n' +
                '2. 定期组织员工进行食品安全培训，提高安全意识；\n' +
                '3. 加强食品原料采购和存储管理，严格执行索证索票制度；\n' +
                '4. 完善设备设施维护保养机制，确保正常运行；\n' +
                '5. 建立食品安全自查和整改记录，持续改进；\n' +
                '6. 严格执行食品留样和温度监测制度；\n' +
                '7. 加强环境卫生管理，定期进行清洁消毒。';
        }
        
        // 关闭PDF分析结果模态框
        closePdfResultModal.addEventListener('click', () => {
            pdfAnalysisResultModal.classList.add('hidden');
        });
        
        // 下载PDF报告
        downloadPdfReportBtn.addEventListener('click', () => {
            alert('PDF报告下载功能将在完整实现中提供');
        });
        
        // 添加到系统
        addDataBtn.addEventListener('click', () => {
            // 模拟从PDF中提取的数据
            const pdfExtractedData = {
                name: '餐厅-' + new Date().getMonth() + 1 + '-' + new Date().getDate(),
                stallCount: Math.floor(Math.random() * 5) + 3,
                inspectionCount: Math.floor(Math.random() * 10) + 5,
                generalIssues: Math.floor(Math.random() * 10),
                seriousIssues: Math.floor(Math.random() * 5),
                criticalIssues: Math.floor(Math.random() * 2)
            };
            
            // 填充表单
            restaurantNameInput.value = pdfExtractedData.name;
            stallCountInput.value = pdfExtractedData.stallCount;
            inspectionCountInput.value = pdfExtractedData.inspectionCount;
            generalIssuesInput.value = pdfExtractedData.generalIssues;
            seriousIssuesInput.value = pdfExtractedData.seriousIssues;
            criticalIssuesInput.value = pdfExtractedData.criticalIssues;
            
            // 计算评分
            calculateScore();
            
            // 关闭模态框
            pdfAnalysisResultModal.classList.add('hidden');
            
            alert('数据已添加到表单，请检查并点击\'添加到列表\'按钮');
        });
        
        // 全局数据存储和管理
        let selectedRestaurantsForComparison = [];
        let comparisonChart = null;
        const STORAGE_KEY_RESTAURANTS = 'restaurant_score_data';
        const STORAGE_KEY_SETTINGS = 'restaurant_score_settings';
        const STORAGE_KEY_DEEPSEEK = 'restaurant_score_deepseek_settings';
        
        // 数据保存功能
        function saveRestaurantData() {
            try {
                const dataToSave = {
                    restaurants: restaurants,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY_RESTAURANTS, JSON.stringify(dataToSave));
                showNotification('数据保存成功', 'success');
                return true;
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('数据保存失败: ' + error.message, 'error');
                return false;
            }
        }
        
        // 数据加载功能
        function loadRestaurantData() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY_RESTAURANTS);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.restaurants && Array.isArray(parsedData.restaurants)) {
                        restaurants = parsedData.restaurants;
                        showNotification('数据加载成功', 'success');
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('加载数据失败:', error);
                showNotification('数据加载失败: ' + error.message, 'error');
                return false;
            }
        }
        
        // 保存应用设置
        function saveApplicationSettings(settings) {
            try {
                const settingsToSave = {
                    ...settings,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settingsToSave));
                return true;
            } catch (error) {
                console.error('保存设置失败:', error);
                return false;
            }
        }
        
        // 加载应用设置
        function loadApplicationSettings() {
            try {
                const savedSettings = localStorage.getItem(STORAGE_KEY_SETTINGS);
                if (savedSettings) {
                    return JSON.parse(savedSettings);
                }
                return null;
            } catch (error) {
                console.error('加载设置失败:', error);
                return null;
            }
        }
        
        // 清除所有数据
        function clearAllData() {
            if (confirm('确定要清除所有保存的数据吗？此操作不可恢复。')) {
                try {
                    localStorage.removeItem(STORAGE_KEY_RESTAURANTS);
                    localStorage.removeItem(STORAGE_KEY_SETTINGS);
                    localStorage.removeItem(STORAGE_KEY_DEEPSEEK);
                    restaurants = [];
                    showNotification('所有数据已清除', 'success');
                    updateTablesAndCharts();
                    return true;
                } catch (error) {
                    console.error('清除数据失败:', error);
                    showNotification('清除数据失败: ' + error.message, 'error');
                    return false;
                }
            }
            return false;
        }
        
        // 导出数据为JSON文件
        function exportData() {
            try {
                const dataToExport = {
                    restaurants: restaurants,
                    settings: loadApplicationSettings(),
                    deepseekSettings: loadDeepseekSettings(),
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `餐厅评分数据_${new Date().toLocaleDateString('zh-CN')}.json`;
                downloadLink.click();
                
                URL.revokeObjectURL(url);
                showNotification('数据导出成功', 'success');
                return true;
            } catch (error) {
                console.error('导出数据失败:', error);
                showNotification('导出数据失败: ' + error.message, 'error');
                return false;
            }
        }
        
        // 导入数据
        function importData(file) {
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // 验证导入数据的完整性
                    if (!importedData.restaurants || !Array.isArray(importedData.restaurants)) {
                        throw new Error('导入数据格式不正确，缺少餐厅数据');
                    }
                    
                    // 应用导入的数据
                    restaurants = importedData.restaurants;
                    
                    // 如果有设置数据，也导入
                    if (importedData.settings) {
                        saveApplicationSettings(importedData.settings);
                    }
                    
                    if (importedData.deepseekSettings) {
                        localStorage.setItem(STORAGE_KEY_DEEPSEEK, JSON.stringify(importedData.deepseekSettings));
                        loadDeepseekSettings();
                    }
                    
                    // 更新UI
                    updateTablesAndCharts();
                    showNotification('数据导入成功', 'success');
                } catch (error) {
                    console.error('导入数据失败:', error);
                    showNotification('导入数据失败: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('文件读取失败', 'error');
            };
            
            reader.readAsText(file);
        }
        
        // 通知提示函数
        function showNotification(message, type = 'info') {
            // 检查是否已存在通知元素
            let notification = document.getElementById('dataNotification');
            
            if (!notification) {
                // 创建通知元素
                notification = document.createElement('div');
                notification.id = 'dataNotification';
                notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 opacity-0 transform translate-y-2';
                document.body.appendChild(notification);
            }
            
            // 设置通知内容和样式
            notification.textContent = message;
            
            // 根据类型设置样式
            notification.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600', 'bg-yellow-600');
            notification.classList.remove('text-blue-100', 'text-green-100', 'text-red-100', 'text-yellow-100');
            
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-600', 'text-green-100');
                    break;
                case 'error':
                    notification.classList.add('bg-red-600', 'text-red-100');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-600', 'text-yellow-100');
                    break;
                default:
                    notification.classList.add('bg-blue-600', 'text-blue-100');
            }
            
            // 显示通知
            notification.classList.remove('opacity-0', 'translate-y-2');
            notification.classList.add('opacity-100', 'translate-y-0');
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 更新表格和图表
        function updateTablesAndCharts() {
            // 这个函数会被init函数内部的逻辑调用
            // 我们会在后续修改init函数来使用这个统一的更新方法
        }
        
        // 餐厅对比功能实现
        
        const addComparisonBtn = document.getElementById('addComparisonBtn');
        const clearComparisonBtn = document.getElementById('clearComparisonBtn');
        const selectedRestaurantsContainer = document.getElementById('selectedRestaurants');
        const compareBtn = document.getElementById('compareBtn');
        const comparisonResult = document.getElementById('comparisonResult');
        const comparisonMetrics = document.getElementById('comparisonMetrics');
        const comparisonAnalysis = document.getElementById('comparisonAnalysis');
        
        // 添加对比餐厅按钮点击事件
        addComparisonBtn.addEventListener('click', function() {
            // 创建餐厅选择模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-100 border border-dark-300 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center p-4 border-b border-dark-300">
                        <h3 class="text-lg font-semibold text-white">选择餐厅进行对比</h3>
                        <button id="closeSelectionModal" class="text-gray-400 hover:text-white">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="p-4 max-h-80 overflow-y-auto">
                        ${restaurants.map(restaurant => `
                            <label class="flex items-center p-2 hover:bg-dark-200 mb-2 cursor-pointer">
                                <input type="checkbox" class="restaurant-select-checkbox form-checkbox text-blue-500 bg-dark-300 border-gray-600" value="${restaurant.id}" ${selectedRestaurantsForComparison.includes(restaurant.id) ? 'checked' : ''}>
                                <span class="ml-2 text-gray-300">${restaurant.name}</span>
                                <span class="ml-auto text-xs text-gray-500">综合评分: ${restaurant.compositeScore.toFixed(2)}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex justify-end p-4 border-t border-dark-300 gap-2">
                        <button id="cancelSelection" class="bg-dark-300 hover:bg-dark-400 text-white px-4 py-2 rounded-none">
                            取消
                        </button>
                        <button id="confirmSelection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-none">
                            确认
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 关闭模态框
            document.getElementById('closeSelectionModal').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            document.getElementById('cancelSelection').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 确认选择
            document.getElementById('confirmSelection').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.restaurant-select-checkbox:checked');
                selectedRestaurantsForComparison = Array.from(checkboxes).map(cb => parseInt(cb.value));
                updateSelectedRestaurantsDisplay();
                document.body.removeChild(modal);
            });
        });
        
        // 清除对比按钮点击事件
        clearComparisonBtn.addEventListener('click', function() {
            selectedRestaurantsForComparison = [];
            updateSelectedRestaurantsDisplay();
            comparisonResult.classList.add('hidden');
        });
        
        // 更新已选择餐厅显示
        function updateSelectedRestaurantsDisplay() {
            selectedRestaurantsContainer.innerHTML = '';
            
            if (selectedRestaurantsForComparison.length === 0) {
                selectedRestaurantsContainer.innerHTML = '<div class="text-gray-500 text-sm">未选择餐厅</div>';
                compareBtn.disabled = true;
            } else {
                selectedRestaurantsForComparison.forEach(restaurantId => {
                    const restaurant = restaurants.find(r => r.id === restaurantId);
                    if (restaurant) {
                        const tag = document.createElement('div');
                        tag.className = 'bg-dark-300 text-gray-300 px-3 py-1 rounded flex items-center';
                        tag.innerHTML = `
                            ${restaurant.name}
                            <button class="ml-2 text-gray-400 hover:text-white text-xs" data-id="${restaurantId}">
                                <i class="fa fa-times"></i>
                            </button>
                        `;
                        
                        // 移除单个餐厅
                        tag.querySelector('button').addEventListener('click', function() {
                            const id = parseInt(this.getAttribute('data-id'));
                            selectedRestaurantsForComparison = selectedRestaurantsForComparison.filter(rId => rId !== id);
                            updateSelectedRestaurantsDisplay();
                            comparisonResult.classList.add('hidden');
                        });
                        
                        selectedRestaurantsContainer.appendChild(tag);
                    }
                });
                compareBtn.disabled = false;
            }
        }
        
        // 开始对比按钮点击事件
        compareBtn.addEventListener('click', function() {
            const comparisonType = document.querySelector('input[name="comparisonType"]:checked').value;
            
            if (comparisonType === 'vertical') {
                // 餐厅间对比（横向）
                compareRestaurantsVertically();
            } else {
                // 历史对比（纵向）
                compareRestaurantsHorizontally();
            }
            
            comparisonResult.classList.remove('hidden');
        });
        
        // 餐厅间对比（横向）
        function compareRestaurantsVertically() {
            const selectedRestaurants = restaurants.filter(r => selectedRestaurantsForComparison.includes(r.id));
            
            // 更新指标对比表格
            comparisonMetrics.innerHTML = `
                <div class="grid grid-cols-5 gap-2 text-sm font-medium text-gray-400 border-b border-dark-300 pb-1 mb-2">
                    <div class="col-span-1">指标</div>
                    ${selectedRestaurants.map(() => '<div class="text-center">餐厅</div>').join('')}
                </div>
                ${generateMetricComparisonRow('餐厅名称', selectedRestaurants.map(r => r.name), 'text-left')}
                ${generateMetricComparisonRow('档口数量', selectedRestaurants.map(r => r.stallCount))}
                ${generateMetricComparisonRow('检查次数', selectedRestaurants.map(r => r.inspectionCount))}
                ${generateMetricComparisonRow('一般问题', selectedRestaurants.map(r => r.generalIssues))}
                ${generateMetricComparisonRow('严重问题', selectedRestaurants.map(r => r.seriousIssues))}
                ${generateMetricComparisonRow('关键问题', selectedRestaurants.map(r => r.criticalIssues))}
                ${generateMetricComparisonRow('问题总数', selectedRestaurants.map(r => r.totalIssues))}
                ${generateMetricComparisonRow('覆盖充分度', selectedRestaurants.map(r => r.coverageRate.toFixed(2)), null, 'coverage')}
                ${generateMetricComparisonRow('问题严重度', selectedRestaurants.map(r => r.issueSeverity.toFixed(2)), null, 'severity')}
                ${generateMetricComparisonRow('综合评分', selectedRestaurants.map(r => r.compositeScore.toFixed(2)), null, 'score')}
            `;
            
            // 生成对比分析报告
            generateVerticalComparisonAnalysis(selectedRestaurants);
            
            // 更新对比图表
            updateComparisonChart(selectedRestaurants);
        }
        
        // 历史对比（纵向）
        function compareRestaurantsHorizontally() {
            // 由于当前没有历史数据，使用模拟数据展示纵向对比效果
            const selectedRestaurant = restaurants.find(r => selectedRestaurantsForComparison.includes(r.id));
            
            if (selectedRestaurant) {
                // 生成模拟历史数据（过去4个月）
                const historyData = generateMockHistoryData(selectedRestaurant);
                
                comparisonMetrics.innerHTML = `
                    <div class="grid grid-cols-5 gap-2 text-sm font-medium text-gray-400 border-b border-dark-300 pb-1 mb-2">
                        <div class="col-span-1">指标</div>
                        <div class="text-center">上月</div>
                        <div class="text-center">前月</div>
                        <div class="text-center">三月前</div>
                        <div class="text-center">四月前</div>
                    </div>
                    ${generateMetricComparisonRow('覆盖充分度', historyData.map(h => h.coverageRate.toFixed(2)), null, 'coverage')}
                    ${generateMetricComparisonRow('问题严重度', historyData.map(h => h.issueSeverity.toFixed(2)), null, 'severity')}
                    ${generateMetricComparisonRow('综合评分', historyData.map(h => h.compositeScore.toFixed(2)), null, 'score')}
                    ${generateMetricComparisonRow('问题总数', historyData.map(h => h.totalIssues))}
                `;
                
                // 生成纵向对比分析报告
                generateHorizontalComparisonAnalysis(selectedRestaurant, historyData);
                
                // 更新纵向对比图表
                updateHorizontalComparisonChart(selectedRestaurant, historyData);
            }
        }
        
        // 生成指标对比行
        function generateMetricComparisonRow(metricName, values, textAlign = 'center', valueType = null) {
            const valueCells = values.map(value => {
                let className = 'px-2 py-1';
                let textColor = 'text-gray-300';
                
                // 根据值类型添加颜色
                if (valueType === 'score') {
                    const numValue = parseFloat(value);
                    if (numValue >= 2) textColor = 'text-red-400';
                    else if (numValue >= 1) textColor = 'text-yellow-400';
                    else textColor = 'text-green-400';
                } else if (valueType === 'severity') {
                    const numValue = parseFloat(value);
                    if (numValue >= 1.5) textColor = 'text-red-400';
                    else if (numValue >= 0.8) textColor = 'text-yellow-400';
                    else textColor = 'text-green-400';
                } else if (valueType === 'coverage') {
                    const numValue = parseFloat(value);
                    if (numValue < 0.6) textColor = 'text-red-400';
                    else if (numValue < 0.8) textColor = 'text-yellow-400';
                    else textColor = 'text-green-400';
                }
                
                return `<div class="${className} ${textColor}" style="text-align: ${textAlign || 'center'}">${value}</div>`;
            }).join('');
            
            return `
                <div class="grid grid-cols-5 gap-2 py-1 border-b border-dark-300/50">
                    <div class="text-gray-400">${metricName}</div>
                    ${valueCells}
                </div>
            `;
        }
        
        // 生成餐厅间对比分析报告
        function generateVerticalComparisonAnalysis(selectedRestaurants) {
            let analysisText = '';
            
            if (selectedRestaurants.length < 2) {
                analysisText = '请至少选择两家餐厅进行横向对比。';
            } else {
                // 找出最佳和最差餐厅
                const bestScoreRestaurant = selectedRestaurants.reduce((best, current) => 
                    current.compositeScore < best.compositeScore ? current : best
                );
                
                const worstScoreRestaurant = selectedRestaurants.reduce((worst, current) => 
                    current.compositeScore > worst.compositeScore ? current : worst
                );
                
                const bestCoverageRestaurant = selectedRestaurants.reduce((best, current) => 
                    current.coverageRate > best.coverageRate ? current : best
                );
                
                const worstSeverityRestaurant = selectedRestaurants.reduce((worst, current) => 
                    current.issueSeverity > worst.issueSeverity ? current : worst
                );
                
                analysisText = `
                    <p><strong class="text-gray-300">对比分析总结：</strong></p>
                    <p class="my-2">本次对比了 ${selectedRestaurants.length} 家餐厅的食品安全检查数据。</p>
                    
                    <p class="my-2"><strong class="text-gray-300">综合表现最佳：</strong> ${bestScoreRestaurant.name}（评分：${bestScoreRestaurant.compositeScore.toFixed(2)}）</p>
                    <p class="my-2"><strong class="text-gray-300">综合表现需改进：</strong> ${worstScoreRestaurant.name}（评分：${worstScoreRestaurant.compositeScore.toFixed(2)}）</p>
                    <p class="my-2"><strong class="text-gray-300">检查覆盖最充分：</strong> ${bestCoverageRestaurant.name}（覆盖率：${bestCoverageRestaurant.coverageRate.toFixed(2)}）</p>
                    <p class="my-2"><strong class="text-gray-300">问题严重度最高：</strong> ${worstSeverityRestaurant.name}（严重度：${worstSeverityRestaurant.issueSeverity.toFixed(2)}）</p>
                    
                    <p class="mt-4"><strong class="text-gray-300">改进建议：</strong></p>
                    <ul class="list-disc pl-5 mt-1 space-y-1">
                        <li>建议表现较差的餐厅参考${bestScoreRestaurant.name}的管理经验</li>
                        <li>增加检查覆盖不足餐厅的检查频率和范围</li>
                        <li>对问题严重度高的餐厅进行专项整改和重点监控</li>
                        <li>定期组织餐厅间的经验交流和学习活动</li>
                    </ul>
                `;
            }
            
            comparisonAnalysis.innerHTML = analysisText;
        }
        
        // 生成纵向对比分析报告
        function generateHorizontalComparisonAnalysis(restaurant, historyData) {
            let trend = 'stable';
            let trendText = '';
            
            // 分析趋势
            const latestScore = restaurant.compositeScore;
            const oldestScore = historyData[historyData.length - 1].compositeScore;
            const scoreDiff = oldestScore - latestScore;
            
            if (scoreDiff > 0.5) {
                trend = 'improving';
                trendText = `显著改善，综合评分下降了 ${scoreDiff.toFixed(2)}`;
            } else if (scoreDiff > 0.1) {
                trend = 'slightlyImproving';
                trendText = `有所改善，综合评分下降了 ${scoreDiff.toFixed(2)}`;
            } else if (scoreDiff < -0.5) {
                trend = 'worsening';
                trendText = `需关注，综合评分上升了 ${Math.abs(scoreDiff).toFixed(2)}`;
            } else if (scoreDiff < -0.1) {
                trend = 'slightlyWorsening';
                trendText = `略有波动，综合评分上升了 ${Math.abs(scoreDiff).toFixed(2)}`;
            } else {
                trendText = '保持稳定';
            }
            
            const analysisText = `
                <p><strong class="text-gray-300">${restaurant.name} 历史数据分析：</strong></p>
                <p class="my-2">本次分析了 ${restaurant.name} 过去4个月的食品安全检查数据趋势。</p>
                
                <p class="my-2"><strong class="text-gray-300">整体趋势：</strong> 
                    <span class="${trend === 'improving' || trend === 'slightlyImproving' ? 'text-green-400' : trend === 'worsening' || trend === 'slightlyWorsening' ? 'text-red-400' : 'text-yellow-400'}">
                        ${trendText}
                    </span>
                </p>
                
                <p class="mt-4"><strong class="text-gray-300">详细分析：</strong></p>
                <ul class="list-disc pl-5 mt-1 space-y-1">
                    <li>当前综合评分：${restaurant.compositeScore.toFixed(2)}，覆盖充分度：${restaurant.coverageRate.toFixed(2)}</li>
                    <li>问题严重度变化趋势：${getTrendDescription(historyData.map(h => h.issueSeverity))}</li>
                    <li>检查覆盖充分度变化趋势：${getTrendDescription(historyData.map(h => h.coverageRate), true)}</li>
                    <li>问题总数变化趋势：${getTrendDescription(historyData.map(h => h.totalIssues))}</li>
                </ul>
                
                <p class="mt-4"><strong class="text-gray-300">改进建议：</strong></p>
                <ul class="list-disc pl-5 mt-1 space-y-1">
                    <li>${trend === 'worsening' ? '需立即进行全面检查和整改' : '继续保持当前的管理措施'}</li>
                    <li>建议增加对高风险区域的检查频率</li>
                    <li>建立问题整改跟踪机制，确保发现问题及时解决</li>
                    <li>定期组织员工食品安全培训，提高安全意识</li>
                </ul>
            `;
            
            comparisonAnalysis.innerHTML = analysisText;
        }
        
        // 获取趋势描述
        function getTrendDescription(values, isPositive = false) {
            const firstValue = values[values.length - 1];
            const lastValue = values[0];
            const diff = lastValue - firstValue;
            
            if (Math.abs(diff) < 0.1) return '基本稳定';
            
            if (isPositive) {
                // 对覆盖充分度等指标，上升是好的
                return diff > 0 ? `持续上升（+${diff.toFixed(2)}）` : `有所下降（-${Math.abs(diff).toFixed(2)}）`;
            } else {
                // 对问题数、严重度等指标，下降是好的
                return diff < 0 ? `持续改善（-${Math.abs(diff).toFixed(2)}）` : `需关注（+${diff.toFixed(2)}）`;
            }
        }
        
        // 生成模拟历史数据
        function generateMockHistoryData(restaurant) {
            const history = [];
            const baseCoverage = restaurant.coverageRate;
            const baseSeverity = restaurant.issueSeverity;
            const baseScore = restaurant.compositeScore;
            const baseIssues = restaurant.totalIssues;
            
            // 生成过去4个月的数据
            for (let i = 1; i <= 4; i++) {
                // 添加一些随机波动
                const coverageRate = Math.max(0, Math.min(1, baseCoverage + (Math.random() - 0.5) * 0.2));
                const issueSeverity = Math.max(0, baseSeverity + (Math.random() - 0.5) * 0.4);
                const compositeScore = (issueSeverity * 0.7) + ((1 - coverageRate) * 0.3);
                const totalIssues = Math.max(0, Math.round(baseIssues + (Math.random() - 0.5) * 4));
                
                history.push({ coverageRate, issueSeverity, compositeScore, totalIssues });
            }
            
            return history.reverse(); // 从旧到新排序
        }
        
        // 更新横向对比图表
        function updateComparisonChart(selectedRestaurants) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const labels = selectedRestaurants.map(r => r.name);
            
            // 销毁现有图表
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '综合评分',
                            data: selectedRestaurants.map(r => r.compositeScore),
                            backgroundColor: selectedRestaurants.map(r => {
                                if (r.compositeScore >= 2) return '#ef4444';
                                if (r.compositeScore >= 1) return '#f59e0b';
                                return '#10b981';
                            }),
                            borderColor: selectedRestaurants.map(r => {
                                if (r.compositeScore >= 2) return '#ef4444';
                                if (r.compositeScore >= 1) return '#f59e0b';
                                return '#10b981';
                            }),
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: '覆盖充分度',
                            data: selectedRestaurants.map(r => r.coverageRate),
                            type: 'line',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#9ca3af'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新纵向对比图表
        function updateHorizontalComparisonChart(restaurant, historyData) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            const labels = ['上月', '前月', '三月前', '四月前'];
            
            // 销毁现有图表
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '综合评分',
                            data: historyData.map(h => h.compositeScore),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: '覆盖充分度',
                            data: historyData.map(h => h.coverageRate),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: '问题严重度',
                            data: historyData.map(h => h.issueSeverity),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${restaurant.name} 历史数据趋势`,
                            color: '#d1d5db'
                        },
                        legend: {
                            labels: {
                                color: '#9ca3af'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    }
                }
            });
        }
        
        // 修改updateTablesAndCharts函数，使其执行表格和图表的更新
        function updateTablesAndCharts() {
            // 重新计算餐厅排名和统计数据
            updateRestaurantStats();
            
            // 重新排序餐厅
            sortRestaurants();
            
            // 更新表格和图表
            updateTables();
            updateCharts();
        }
        
        // 初始化数据操作事件监听器
        function initDataOperations() {
            // 保存数据按钮
            document.getElementById('saveDataBtn')?.addEventListener('click', saveRestaurantData);
            
            // 加载数据按钮
            document.getElementById('loadDataBtn')?.addEventListener('click', function() {
                if (loadRestaurantData()) {
                    updateTablesAndCharts();
                }
            });
            
            // 导出数据按钮
            document.getElementById('exportDataBtn')?.addEventListener('click', exportData);
            
            // 导入数据输入框
            document.getElementById('importDataInput')?.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    importData(e.target.files[0]);
                    // 重置文件输入，允许重复选择同一个文件
                    e.target.value = '';
                }
            });
            
            // 清除数据按钮
            document.getElementById('clearDataBtn')?.addEventListener('click', clearAllData);
            
            // 在添加/编辑餐厅后自动保存
            const originalAddRestaurant = addRestaurant; // 保存原始函数
            window.addRestaurant = function(restaurant) {
                const result = originalAddRestaurant(restaurant);
                if (result) {
                    // 延迟保存，避免频繁操作
                    setTimeout(saveRestaurantData, 500);
                }
                return result;
            };
        }
        
        // 修改init函数，在初始化时加载数据
        const originalInit = init; // 保存原始的init函数
        window.init = function() {
            const result = originalInit();
            
            // 尝试加载保存的数据
            loadRestaurantData();
            
            // 初始化数据操作事件
            initDataOperations();
            
            return result;
        };
        
        // 生成PDF报告功能
        function generatePdfReport() {
            const doc = new jspdf.jsPDF();
            
            // 设置中文字体兼容
            doc.setFontSize(20);
            doc.text('餐厅安全检查分析报告', 105, 20, { align: 'center' });
            
            // 添加日期
            const date = new Date();
            doc.setFontSize(12);
            doc.text(`生成日期: ${date.toLocaleDateString('zh-CN')}`, 20, 35);
            
            // 添加统计摘要
            doc.setFontSize(16);
            doc.text('统计摘要', 20, 50);
            
            // 获取统计数据
            const totalRestaurants = document.getElementById('totalRestaurants')?.textContent || '0';
            const avgScore = document.getElementById('avgScore')?.textContent || '0';
            const totalIssues = document.getElementById('totalIssues')?.textContent || '0';
            
            let yPos = 60;
            doc.setFontSize(12);
            doc.text(`总餐厅数: ${totalRestaurants}`, 20, yPos);
            yPos += 10;
            doc.text(`平均综合评分: ${avgScore}`, 20, yPos);
            yPos += 10;
            doc.text(`总问题数: ${totalIssues}`, 20, yPos);
            
            // 添加餐厅表格数据
            yPos += 15;
            doc.setFontSize(16);
            doc.text('餐厅详细数据', 20, yPos);
            
            // 准备表格数据
            const rows = [];
            const tableBody = document.querySelector('#restaurantTable tbody');
            if (tableBody) {
                const trElements = tableBody.querySelectorAll('tr:not(:last-child)'); // 排除空数据提示行
                trElements.forEach(tr => {
                    const row = [];
                    const tdElements = tr.querySelectorAll('td');
                    if (tdElements.length >= 8) { // 确保有足够的单元格
                        row.push(tdElements[0]?.textContent?.trim() || ''); // 排名
                        row.push(tdElements[1]?.textContent?.trim() || ''); // 餐厅名称
                        row.push(tdElements[2]?.textContent?.trim() || ''); // 档口数
                        row.push(tdElements[3]?.textContent?.trim() || ''); // 检查次数
                        row.push(tdElements[5]?.textContent?.trim() || ''); // 覆盖充分度
                        row.push(tdElements[6]?.textContent?.trim() || ''); // 问题严重度
                        row.push(tdElements[7]?.textContent?.trim() || ''); // 综合评分
                        rows.push(row);
                    }
                });
            }
            
            // 添加表格到PDF
            if (rows.length > 0) {
                yPos += 10;
                doc.autoTable({
                    startY: yPos,
                    head: [['排名', '餐厅名称', '档口数', '检查次数', '覆盖充分度', '问题严重度', '综合评分']],
                    body: rows,
                    theme: 'grid',
                    styles: {
                        fontSize: 10,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [41, 98, 255]
                    }
                });
            }
            
            // 添加自定义水印
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text('山西大学后勤管理处饮食文化中心', 105, doc.internal.pageSize.height - 10, { align: 'center' });
            }
            
            // 保存PDF
            doc.save(`餐厅分析报告_${date.toLocaleDateString('zh-CN').replace(/\//g, '-')}.pdf`);
            
            // 显示成功提示
            showNotification && showNotification('PDF报告生成成功！', 'success');
        }
        
        // 添加日期相关功能
        function initDateFunctions() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkDate')?.value = today;
            document.getElementById('restaurantDate')?.value = today;
            
            // 设置日期范围默认值（过去一个月到今天）
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().split('T')[0];
            document.getElementById('dateRangeStart')?.value = lastMonthStr;
            document.getElementById('dateRangeEnd')?.value = today;
            
            // 应用日期筛选按钮
            document.getElementById('applyDateFilterBtn')?.addEventListener('click', function() {
                const startDate = document.getElementById('dateRangeStart')?.value;
                const endDate = document.getElementById('dateRangeEnd')?.value;
                
                if (startDate && endDate) {
                    // 筛选餐厅数据
                    filterRestaurantsByDate(startDate, endDate);
                    // 显示筛选信息
                    showNotification && showNotification(`已筛选 ${startDate} 至 ${endDate} 的数据`, 'info');
                } else {
                    showNotification && showNotification('请选择完整的日期范围', 'error');
                }
            });
        }
        
        // 根据日期范围筛选餐厅数据
        function filterRestaurantsByDate(startDate, endDate) {
            // 获取所有餐厅数据
            const allRestaurants = restaurants || [];
            
            // 如果餐厅数据中没有日期字段，则不进行筛选
            if (!allRestaurants.some(r => r.date)) {
                showNotification && showNotification('餐厅数据中不包含日期信息，无法进行筛选', 'warning');
                return;
            }
            
            // 筛选指定日期范围内的餐厅
            const filteredRestaurants = allRestaurants.filter(restaurant => {
                const restaurantDate = restaurant.date;
                return restaurantDate >= startDate && restaurantDate <= endDate;
            });
            
            // 更新显示
            if (filteredRestaurants.length > 0) {
                // 使用筛选后的数据
                restaurants = filteredRestaurants;
                updateTablesAndCharts && updateTablesAndCharts();
            } else {
                showNotification && showNotification('所选日期范围内没有数据', 'info');
            }
        }
        
        // 修改addRestaurant函数，添加日期信息
        const originalAddRestaurant = window.addRestaurant;
        window.addRestaurant = function(restaurant) {
            // 添加日期信息
            const checkDate = document.getElementById('restaurantDate')?.value || new Date().toISOString().split('T')[0];
            restaurant.date = checkDate;
            
            // 调用原始函数
            return originalAddRestaurant(restaurant);
        };
        
        // 修改init函数，添加PDF生成事件监听和日期初始化
        const originalInit = window.init;
        window.init = function() {
            const result = originalInit();
            
            // 为PDF导出按钮添加事件监听
            const pdfBtn = document.getElementById('generatePdfReportBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', generatePdfReport);
            }
            
            // 初始化日期功能
            initDateFunctions();
            
            return result;
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
